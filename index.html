<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-height: 70vh; overflow-y: auto; }
    .button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .active { background-color: #007bff; color: white; }
    .contact-list { list-style: none; padding: 0; }
    .contact-list li { padding: 10px; border-bottom: 1px solid #ddd; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; }
    .form-group input, .form-group textarea { width: 100%; padding: 5px; }
    .close:hover { cursor: pointer; }
    .file-preview { margin-top: 5px; }
    .file-preview img { max-width: 100px; max-height: 100px; }
    .file-preview a { color: #007bff; text-decoration: underline; }
    .loading { text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div id="network-app">
    <div class="modal" id="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">Ã—</span>
        <div id="category-buttons">
          <button class="button active" onclick="setCategory('clients')">Clients</button>
          <button class="button" onclick="setCategory('real estate')">Real Estate</button>
          <button class="button" onclick="setCategory('tradies')">Tradies</button>
        </div>
        <div id="subcategory-buttons" style="display: none;">
          <button class="button active" onclick="setSubcategory('leads')">Leads</button>
          <button class="button" onclick="setSubcategory('customers')">Customers</button>
        </div>
        <div id="contact-list"></div>
        <div id="contact-form" style="display: none;">
          <h3 id="form-title"></h3>
          <form id="contact-form-element">
            <div id="standard-fields"></div>
            <div id="custom-fields"></div>
            <button type="submit" class="button">Save</button>
            <button type="button" class="button" onclick="closeForm()">Cancel</button>
          </form>
          <button id="new-contact-btn" class="button" style="display: none;" onclick="showNewContactForm()">New Contact</button>
        </div>
      </div>
    </div>
    <button class="button" onclick="openModal()">Network</button>
  </div>

  <script>
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IllnUUp0OHppcGhlQVNtTXo2SEpmIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4ODA3OTc5ODk1LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9._deFuXYQdzXwzy8T_9kzzA_CxIX_pPnaJKcgwaetKHg";
    const locationId = "YgQJt8zipheASmMz6HJf";
    let activeCategory = 'clients';
    let activeSubcategory = 'leads';
    let selectedContactId = null;
    let customFieldsMap = {};
    let customerCustomFields = [];

    // Define all 88 custom fields from Client Intake & Acquisition Form
    const customFieldLabels = [
      'Full Name', 'Address', 'Alternate Number', 'Citizenship Status', 'REIQ Checklist', 'Notes',
      'Upload DL/Passport', 'Alternate Email', 'Preferred Method of Communication', 'Type of Service',
      'Form 6 Sent?', 'Form 6 Executed', 'Form 6 Sent to All Parties', 'Client Agreement Sent?',
      'Client Agreement Executed', 'Client Agreement Sent to All Parties', 'Service Fee', 'Fee to be Paid',
      'Retainer Including GST', 'Retainer Invoice Paid', 'Referral Name', 'Referral Company',
      'Referral Phone', 'Referral Email', 'Referral Fee Paid?', 'Mortgage Company', 'Name of the Broker',
      'Address (Mortgage Broker)', 'Phone (Mortgage Broker)', 'Email (Mortgage Broker)', 'Finance Approval',
      'Date of Expiry', 'Name of the Conveyancer', 'Company (Conveyancer)', 'Address (Conveyancer)',
      'Phone (Conveyancer)', 'Email (Conveyancer)', 'Name of the Accountant', 'Company (Accountant)',
      'Address (Accountant)', 'Phone (Accountant)', 'Email (Accountant)', 'Name of the Financial Adviser',
      'Company (Financial Adviser)', 'Address (Financial Adviser)', 'Phone (Financial Adviser)',
      'Email (Financial Adviser)', 'Reason for Purchase', 'Strategy Outcomes', 'Tenant', 'Areas/Locations',
      'Building Type', 'Land Size', 'Budget', 'Time Frame', 'Must Haves', 'Second Choice Must Haves',
      'Previously Viewed Properties', 'Potential Properties', 'Property Identified', 'CMA Sent?', 'Flood',
      'Bushfire', 'Heritage', 'Title Search', 'Mortgage Broker Check Complete', 'Contract Sent to Solicitor',
      'Offer Received by Real Estate Agent', 'Full Name (Client 2)', 'Address (Client 2)',
      'Full Name (Client 3)', 'Phone (Client 2)', 'Phone (Client 3)', 'Alternate Number (Client 2)',
      'Alternate Number (Client 3)', 'Email (Client 2)', 'Alternate Email (Client 2)',
      'Alternate Email (Client 3)', 'Notes (Client 2)', 'Notes (Client 3)', 'Upload DL/Passport (Client 2)',
      'Upload DL/Passport (Client 3)', 'Citizenship Status (Client 2)', 'Citizenship Status (Client 3)',
      'REIQ Checklist (Client 2)', 'REIQ Checklist (Client 3)', 'Address (Client 3)', 'Email (Client 3)'
    ];

    // Fetch custom fields dynamically and map them
    async function fetchCustomFields() {
      const url = `https://rest.gohighlevel.com/v1/custom-fields?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('Custom Fields Response:', JSON.stringify(data, null, 2));

        customFieldsMap = data.customFields.reduce((map, field) => {
          map[field.label] = field.id;
          return map;
        }, {});

        customerCustomFields = customFieldLabels.map(label => {
          const id = customFieldsMap[label];
          if (!id) {
            console.warn(`Custom field "${label}" not found in GHL`);
            return null;
          }
          return {
            label,
            id,
            type: label.includes('Upload') || label.includes('REIQ Checklist') ? 'file' : label.includes('Notes') ? 'textarea' : 'text'
          };
        }).filter(field => field !== null);
      } catch (error) {
        console.error('Error fetching custom fields:', error);
      }
    }

    // Initial fetch of custom fields
    fetchCustomFields();

    function openModal() {
      document.getElementById('modal').style.display = 'block';
      setCategory('clients');
      setSubcategory('leads');
      loadContacts();
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
      closeForm();
    }

    function closeForm() { 
      document.getElementById('contact-form').style.display = 'none'; 
    }

    function setCategory(category) {
      closeForm();
      activeCategory = category;
      document.getElementById('subcategory-buttons').style.display = category === 'clients' ? 'block' : 'none';
      setSubcategory(category === 'clients' ? 'leads' : '');
      document.querySelectorAll('#category-buttons .button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`#category-buttons .button[onclick="setCategory('${category}')"]`).classList.add('active');
    }

    function setSubcategory(subcategory) {
      closeForm();
      if (activeCategory !== 'clients') return;
      activeSubcategory = subcategory;
      loadContacts();
      document.getElementById('new-contact-btn').style.display = subcategory === 'leads' ? 'block' : 'none';
      document.querySelectorAll('#subcategory-buttons .button').forEach(btn => btn.classList.remove('active'));
      if (subcategory) {
        document.querySelector(`#subcategory-buttons .button[onclick="setSubcategory('${subcategory}')"]`).classList.add('active');
      }
    }

    async function loadContacts() {
      if (activeCategory !== 'clients' || !activeSubcategory) return;
      const tag = activeSubcategory === 'leads' ? 'new lead' : 'customer';
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(tag)}`;
      try {
        document.getElementById('contact-list').innerHTML = '<p class="loading">Loading contacts...</p>';
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('API Response:', JSON.stringify(data, null, 2));

        const contacts = data.contacts || (data.contact ? [data.contact] : []);
        const filteredContacts = contacts.filter(contact => (contact.tags || []).includes(tag));

        const list = document.getElementById('contact-list');
        list.innerHTML = filteredContacts.length === 0 ? '<p>No contacts found.</p>' : '';
        filteredContacts.forEach(contact => {
          const firstName = contact.firstName || 'Unknown';
          const lastName = contact.lastName || '';
          const contactId = contact.id;
          const li = document.createElement('li');
          li.innerHTML = `${firstName} ${lastName} <button class="button" onclick="loadContact('${contactId}')">View</button>` + 
                         (activeSubcategory === 'leads' ? ` <button class="button" onclick="changeToCustomer('${contactId}')">Change to Customer</button>` : '');
          list.appendChild(li);
        });
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contact-list').innerHTML = '<p>Error loading contacts.</p>';
      }
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}&include=customFields`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        const contact = data.contact || data;
        console.log('Single Contact Response:', JSON.stringify(contact, null, 2));

        // Standard fields
        const standardFields = [
          { label: 'First Name', key: 'firstName', id: 'firstName', value: contact.firstName || '', required: true },
          { label: 'Last Name', key: 'lastName', id: 'lastName', value: contact.lastName || '', required: true },
          { label: 'Email', key: 'email', id: 'email', value: contact.email || '', type: 'email' },
          { label: 'Phone', key: 'phone', id: 'phone', value: contact.phone || '', type: 'tel' },
        ];

        document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
          <div class="form-group">
            <label>${field.label}:</label>
            <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''}>
          </div>
        `).join('');

        // Custom fields for Customers
        const customFieldsDiv = document.getElementById('custom-fields');
        if (activeSubcategory === 'customers') {
          const customFieldValues = contact.customField || [];
          const fieldMap = customFieldValues.reduce((map, cf) => {
            const value = cf.value && typeof cf.value === 'object' ? cf.value[Object.keys(cf.value)[0]]?.url || cf.value : cf.value;
            map[cf.id] = value;
            return map;
          }, {});

          // Handle Full Name and Address as computed fields
          const fullNameValue = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
          const addressComponents = [
            fieldMap[customFieldsMap['Street Address']] || contact.address1 || '',
            fieldMap[customFieldsMap['City']] || contact.city || '',
            fieldMap[customFieldsMap['Country']] || contact.country || '',
            fieldMap[customFieldsMap['State']] || contact.state || '',
            fieldMap[customFieldsMap['Postal Code']] || contact.postalCode || ''
          ].filter(v => v);
          const addressValue = addressComponents.join(', ');

          document.getElementById('custom-fields').innerHTML = customerCustomFields.map(field => {
            let fieldValue = fieldMap[field.id] || '';
            if (field.label === 'Full Name') fieldValue = fullNameValue;
            if (field.label === 'Address') fieldValue = addressValue;
            if (field.type === 'file') {
              return `
                <div class="form-group">
                  <label>${field.label}:</label>
                  <p class="file-preview">${fieldValue ? (fieldValue.endsWith('.png') || fieldValue.endsWith('.jpg') || fieldValue.endsWith('.jpeg') ? 
                    `<img src="${fieldValue}" alt="${field.label}">` : 
                    `<a href="${fieldValue}" target="_blank">${fieldValue.split('/').pop()}</a>`) : 'No file uploaded'}</p>
                  <input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf">
                </div>
              `;
            }
            return `
              <div class="form-group">
                <label>${field.label}:</label>
                ${field.type === 'textarea' ? 
                  `<textarea id="custom_${field.id}">${fieldValue}</textarea>` : 
                  `<input type="text" id="custom_${field.id}" value="${fieldValue}">`}
              </div>
            `;
          }).join('');
        } else {
          customFieldsDiv.innerHTML = '';
        }

        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('contact-form').style.display = 'block';
      } catch (error) {
        console.error('Error loading contact:', error);
        document.getElementById('contact-form').innerHTML = '<p>Error loading contact.</p>';
      }
    }

    async function showNewContactForm() {
      selectedContactId = null;
      const standardFields = [
        { label: 'First Name', key: 'firstName', id: 'firstName', value: '', required: true },
        { label: 'Last Name', key: 'lastName', id: 'lastName', value: '', required: true },
        { label: 'Email', key: 'email', id: 'email', value: '', type: 'email' },
        { label: 'Phone', key: 'phone', id: 'phone', value: '', type: 'tel' },
      ];

      document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
        <div class="form-group">
          <label>${field.label}:</label>
          <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''}>
        </div>
      `).join('');

      document.getElementById('custom-fields').innerHTML = activeSubcategory === 'customers' ? 
        customerCustomFields.map(field => `
          <div class="form-group">
            <label>${field.label}:</label>
            ${field.type === 'file' ? 
              `<input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf">` :
              field.type === 'textarea' ? 
              `<textarea id="custom_${field.id}"></textarea>` : 
              `<input type="text" id="custom_${field.id}">`}
          </div>
        `).join('') : '';
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.getElementById('contact-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [activeSubcategory === 'leads' ? 'new lead' : 'customer'],
      };

      // Construct address from component fields if needed
      const addressFields = ['Street Address', 'City', 'Country', 'State', 'Postal Code'].map(label => customFieldsMap[label]);
      if (activeSubcategory === 'customers' && addressFields.some(id => document.getElementById(`custom_${id}`))) {
        const address = addressFields.map(id => document.getElementById(`custom_${id}`)?.value || '').filter(v => v).join(', ');
        data.customField = data.customField || [];
        data.customField.push({ id: customFieldsMap['Address'], value: address || '' });
      }

      if (activeSubcategory === 'customers') {
        data.customField = await Promise.all(customerCustomFields.map(async field => {
          if (field.type === 'file') {
            const fileInput = document.getElementById(`custom_${field.id}_new`);
            if (fileInput && fileInput.files.length > 0) {
              const formData = new FormData();
              formData.append('file', fileInput.files[0]);
              formData.append('contactId', selectedContactId || '');
              formData.append('fieldId', field.id);

              try {
                const response = await fetch('https://https://custom-menu-backend-661398661b06.herokuapp.com/upload', {
                  method: 'POST',
                  body: formData,
                });
                const result = await response.json();
                if (result.url) {
                  return { id: field.id, value: result.url };
                }
                throw new Error('Upload failed');
              } catch (error) {
                console.error('File upload error:', error);
                return { id: field.id, value: '' };
              }
            }
            return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
          }
          return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
        }));
        data.customField = data.customField.filter(cf => cf.value !== '');
      }

      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        console.log('Save Contact Response:', await response.json());
        alert(selectedContactId ? 'Contact updated successfully!' : 'Contact created successfully!');
        closeForm();
        loadContacts();
      } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact. Please try again.');
      }
    });

    async function changeToCustomer(contactId) {
      selectedContactId = contactId;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');

        const updateResponse = await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        if (!updateResponse.ok) throw new Error(`HTTP error! Status: ${updateResponse.status}`);
        console.log('Tag Update Response:', await updateResponse.json());
        setSubcategory('customers');
        loadContact(contactId);
        alert('Contact changed to Customer successfully!');
      } catch (error) {
        console.error('Error changing to customer:', error);
        alert('Error changing contact to Customer.');
      }
    }
  </script>
</body>
</html>