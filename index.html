8833 BDT to ABIDUR RAHMAN
joining 18th june
12.5 bdt is salary and 30 usd is paid


<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/692ff4c859.js" crossorigin="anonymous"></script>
  <style>
    .modal {
      transition: opacity 0.3s ease-in-out;
      display: none;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      padding: 0;
      overflow: hidden;
      display: flex;
      background-color: #fff;
      margin-top: 15px;
    }

    .section-body {
      transition: max-height 0.8s ease;
    }

    .hidden {
      display: none;
    }


    .modal-open .modal-content {
      transform: translateY(0);
    }

    .button {
      transition: background-color 0.3s ease, transform 0.1s ease;
      color: white;
    }

    .button:hover {
      transform: scale(1.05);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      transition: border-color 0.3s ease;
      font-size: 16px;
      padding: 12px;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: #d0a547;
      outline: none;
    }

    .form-actions {
      position: sticky;
      bottom: -5%;
      background-color: #fff;
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      z-index: 10;
    }

    .loader {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-left: 1rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .bg-gold {
      background-color: #d0a547;
    }

    .text-gold {
      color: #d0a547;
    }

    .bg-dark-green {
      background-color: #304528;
    }

    .text-dark-green {
      color: #304528;
    }

    .sidebar {
      width: 250px;
      background-color: #304528;
      padding: 20px;
      border-right: 1px solid #e5e7eb;
      overflow-y: hidden;
    }

    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar ul li {
      margin-bottom: 10px;
    }

    .sidebar ul li button {
      width: 100%;
      text-align: left;
      padding: 10px;
      border-radius: 4px;
    }

    .search-bar {
      width: 200px;
    }

    .action-bar {
      width: 100%;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 10px 20px;
      z-index: 20;
    }

    .tooltip-text {
      display: none;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 8px;
      background-color: #1f2937;
      color: white;
      font-size: 12px;
      border-radius: 4px;
      padding: 4px 8px;
      white-space: nowrap;
      z-index: 10;
    }

    .group:hover .tooltip-text {
      display: block;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center" onload="openModal()">
  <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="modal-content">
      <div class="sidebar">
        <h3 class="text-2xl font-semibold text-white mb-4">Categories</h3>
        <ul>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg"
              onclick="setCategory('leads')">Leads</button></li>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg"
              onclick="setCategory('customers')">Customers</button></li>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg"
              onclick="setCategory('real estate')">Real Estate</button></li>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg"
              onclick="setCategory('Conveyance lawyers')">Lawyers</button></li>
          <li><button class="bg-dark-green text-white px-4 py-2 rounded-lg button"
              onclick="setCategory('tradies')">Tradies</button></li>
          <li><button class="bg-dark-green text-white px-4 py-2 rounded-lg"
              onclick="setCategory('finance')">Finance</button></li>
        </ul>
      </div>
      <div class="main-content">

        <div class="flex justify-between items-center mb-4 mt-8">
          <h2 class="text-2xl font-semibold text-dark-green">Network Contacts</h2>

          <input type="text" id="search-input" placeholder="Search contacts..."
            class="search-bar p-2 border border-gray-300 rounded-lg" oninput="searchContacts()">
        </div>

        <div id="action-bar" class="action-bar">
          <div class="flex space-x-4">
            <div class="relative group">
              <button class="but px-4 py-2 rounded-lg disabled:opacity-50" onclick="bulkDelete()" disabled>
                <i class="fa-solid fa-trash"></i>
              </button>
              <span class="tooltip-text">Delete Selected</span>
            </div>
            <div class="relative group">
              <button class="butt px-4 py-2 rounded-lg disabled:opacity-50" onclick="bulkLoadContacts()" disabled>
                <i class="fa-solid fa-edit"></i>
              </button>
              <span class="tooltip-text">edit Selected</span>
            </div>
            <div class="relative group">
              <button class=" px-4 py-2 rounded-lg disabled:opacity-50" onclick="bulkAddNote()" disabled>
                <i class="fa-solid fa-file-pen"></i>
              </button>
              <span class="tooltip-text">Add Note to Selected</span>
            </div>
            <div class="relative group">
              <button class=" px-4 py-2 rounded-lg disabled:opacity-50" onclick="bulkChangeToCustomer()"
                style="display: none;" id="change-to-customer-btn" disabled>
                <i class="fa-solid fa-person-walking-arrow-right"></i>
              </button>
              <span class="tooltip-text">Change to Customer</span>
            </div>
          </div>
        </div>

        <hr class="my-4">
        <div id="contact-list" class="bg-gray-50 p-4 rounded-lg"></div>
        <button id="new-contact-btn" class="button bg-gold text-white px-4 py-2 rounded-lg mt-2 hover:bg-yellow-600"
          style="display: none; background: #d0a547;" onclick="showNewContactForm()">New Contact</button>
        <div id="contact-form" class="mt-4" style="display: none;">
          <div id="form-header" class="flex justify-between items-center mb-4">
            <h3 id="form-title" class="text-xl font-semibold"></h3>
            <div id="form-buttons"></div>
          </div>
          <form id="contact-form-element">
            <div class="section" id="persons-section">
              <div class="section-header flex items-center cursor-pointer">
                <i class="fa-regular fa-circle-right mr-2 toggle-icon"></i>
                <h3 class="text-lg font-semibold">Additional Persons</h3>
              </div>
              <div class="section-body hidden">
                <!-- person fields get appended here -->
                <div id="additional-persons" class="space-y-4"></div>
              </div>
            </div>
            <div class="section" id="customers-section">
              <div class="section-header flex items-center cursor-pointer">
                <i class="fa-regular fa-circle-down mr-2 toggle-icon"></i>
                <h3 class="text-lg font-semibold">Customer Details</h3>
              </div>
              <div class="section-body">
                <!-- all your customer form fields here -->
                <div id="standard-fields" class="space-y-4 mt-4"></div>
                <div id="custom-fields" class="space-y-4 mt-4"></div>
              </div>
            </div>
            <div class="form-actions flex space-x-2">
              <button type="submit"
                class="button bg-dark-green text-white px-6 py-2 rounded-lg hover:bg-green-800 flex items-center">
                Save
                <span id="form-loader" class="loader"></span>
              </button>
              <button type="button" class="button bg-gray-300 text-white px-6 py-2 rounded-lg hover:bg-gray-400"
                onclick="closeForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IllnUUp0OHppcGhlQVNtTXo2SEpmIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4ODA3OTc5ODk1LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9._deFuXYQdzXwzy8T_9kzzA_CxIX_pPnaJKcgwaetKHg";
    const locationId = "YgQJt8zipheASmMz6HJf";
    let activeCategory = 'leads';
    let selectedContactId = null;
    let allContacts = [];
    let currentTag = '';
    let selectedContacts = new Set();
    let personCount = 1; // Tracks additional persons starting from Person 2
    const additionalPersonsId = 'dbxx7Uf3tenq39Ajr4se';
    const driversLicenseFieldId = 'bxUENGu1BODoeX4zcbyQ';
    const citizenshipCertFieldId = 'WFc5m6oTaIRU6QKQVlxn';

    const customerCustomFields = [
      { label: 'Full Name', id: 'EXjXnQEL140VE4XYhaSX', type: 'TEXT' },
      { label: 'Address', id: 'xiMyfob6XvYdCJ2mUFvs', type: 'LARGE_TEXT' },
      { label: 'Alternate Number', id: 'jvAsiZOUQaCGJIovm6ow', type: 'PHONE' },
      { label: 'Citizenship Status', id: 'PEVvVcPisnmdY3qoYwyR', type: 'TEXT' },
      { label: 'REIQ Checklist', id: 'rxOfHP9T8qdurVaokT2s', type: 'FILE_UPLOAD' },
      { label: 'Notes', id: 'NvQGPZLuWhQ9yYXKp9ld', type: 'LARGE_TEXT' },
      { label: 'Upload DL/Passport', id: 'HOhKJUkCUTScTWamVlZf', type: 'FILE_UPLOAD' },
      { label: 'Alternate email', id: 'KZXiIduGXfQa4gcpSAHv', type: 'TEXT' },
      { label: 'Preferred Method of Communication', id: 'grhYMh52GpDD8QuNuo0J', type: 'MULTIPLE_OPTIONS', options: ['Email', 'Phone', 'Text', 'In-Person'] },
      { label: 'Type of Service', id: 'sHX29V5gxwBYO4WMTQHp', type: 'RADIO', options: ['Full Service Buyers Advocacy', 'Auction Bidding', 'Negotiation Only'] },
      { label: 'Form 6 Sent?', id: 'PR7PRh4wuvF9yrMLhaZF', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Form 6 Executed', id: 'KQz5NQgoGq1l6sI8YPk6', type: 'CHECKBOX', options: ['Yes, Signed by all parties'] },
      { label: 'Form 6 Sent to all parties', id: 'APFoTEdW0JHfH5uJIqUL', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Client Agreement Sent?', id: 'iPFysM90lheoQzV0FOBM', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Client Agreement Executed', id: '4sFw9DsvvygEWyyl2wOx', type: 'CHECKBOX', options: ['Yes, Agreement Signed'] },
      { label: 'Client Agreement sent to all Parties', id: 'CL0w2AcSvCkjyo4L15ip', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Service Fee', id: 'FLP394K9sPjDT21C0Yda', type: 'TEXT' },
      { label: 'Fee to be Paid', id: 'E6fHsabXPU5QkUd3f6wI', type: 'SINGLE_OPTIONS', options: ['Unconditional', 'Conditional', 'Not Applicable'] },
      { label: 'Retainer including GST', id: 'qcWKnqkUOgM3X9bVCrbO', type: 'TEXT' },
      { label: 'Retainer Invoice Paid', id: 'yGmz10g9dX8itDkh5Emo', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Referral Name', id: '6uIIMjIfV0XQ4jwn1ZXv', type: 'TEXT' },
      { label: 'Referral Company', id: 'yb56Vm4w6pioj7Ry8xOi', type: 'TEXT' },
      { label: 'Referral Phone', id: 'mhRM0JSI71O4bE6D9HnA', type: 'PHONE' },
      { label: 'Referral Email', id: '7Yfw3ndm4LlMZWRt08l1', type: 'TEXT' },
      { label: 'Referral Fee Paid?', id: '6AlnT4R8lKsHz12XIuht', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Mortgage Company', id: 'lOWvhGItK1DfcYdmEmr5', type: 'TEXT' },
      { label: 'Name of the Broker', id: 'zF8zaixssgBPmrmaKFv7', type: 'TEXT' },
      { label: 'Address (Mortgage Broker)', id: 'v6YC1hH9al2CAH2O1YQZ', type: 'LARGE_TEXT' },
      { label: 'Phone (Mortgage Broker)', id: '4nfCxk7ACGXPJYOhZ98q', type: 'PHONE' },
      { label: 'Email (Mortgage Broker)', id: 'S2AKVZq7g9sXm7Qnf4ad', type: 'TEXT' },
      { label: 'Finance Approval', id: 'VDFuiC8FcBXn6A6g0eW9', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Date of Expiry', id: '2jj35L7SgYQVh22CjA4b', type: 'DATE' },
      { label: 'Name of the Conveyancer', id: '0BgAiLdSVF9JxQ28qibZ', type: 'TEXT' },
      { label: 'Company (Conveyancer)', id: 'tVcyZhEtB0G3ydzQB2vi', type: 'TEXT' },
      { label: 'Address (Conveyancer)', id: '5MfJnwZsjSpGpJNGFqBj', type: 'LARGE_TEXT' },
      { label: 'Phone (Conveyancer)', id: '5JEWkh4EfSQ1wEc0pfEq', type: 'PHONE' },
      { label: 'Email (Conveyancer)', id: 'RbnDMwGZxcCw2TAhtXdf', type: 'TEXT' },
      { label: 'Name of the Accountant', id: 'zLWuKlNFCy77I9Rh2JUg', type: 'TEXT' },
      { label: 'Company (Accountant)', id: 'sc3jlus2FEvrZo6bkGGs', type: 'TEXT' },
      { label: 'Address (Accountant)', id: '4O8RZbvD8yAt9jxsaL8f', type: 'LARGE_TEXT' },
      { label: 'Phone (Accountant)', id: 'uj1nEbRZRfU61BEAXItg', type: 'PHONE' },
      { label: 'Email (Accountant)', id: 'yJZJ5PlmZDaHKkz2hy3M', type: 'TEXT' },
      { label: 'Name of the Financial Adviser', id: 'iE8WWJ9Ye7Z32To1KGoy', type: 'TEXT' },
      { label: 'Company (Financial Adviser)', id: 'LRS2RQjK5qYL8fWyfxzs', type: 'TEXT' },
      { label: 'Address (Financial Adviser)', id: 'YInzODdGmRDeWGvtA6kv', type: 'LARGE_TEXT' },
      { label: 'Phone (Financial Adviser)', id: 'nnxNZEZSg6Nw1sysMzhh', type: 'PHONE' },
      { label: 'Email (Financial Adviser)', id: 'p61NEhKJLIOyIz7qeqpb', type: 'TEXT' },
      { label: 'Reason for Purchase', id: 'P1y8L9Xk1N9eRdQ2rKVr', type: 'MULTIPLE_OPTIONS', options: ['Owner Occupier', 'Investment', 'Holiday Home'] },
      { label: 'Strategy Outcomes', id: 'gINIpN4sR404ahNgyPkX', type: 'MULTIPLE_OPTIONS', options: ['Renovation Potential', 'Subdivision Potential', 'Development Potential'] },
      { label: 'Tenant', id: 'ti1qc7zG8ZVBfnkqm7Zd', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Areas/Locations', id: 'uAq6W9XWSaqTU9P5mSxr', type: 'LARGE_TEXT' },
      { label: 'Building Type', id: 'jUJ7iCewuxlFttWfPLLu', type: 'LARGE_TEXT' },
      { label: 'Land Size', id: 'fqANWu9PRJHBs0A0PVOe', type: 'LARGE_TEXT' },
      { label: 'Budget', id: 'nLNN1njsqcMmImQXDZdU', type: 'LARGE_TEXT' },
      { label: 'Time Frame', id: 'jkLvLtBIenZ66IHg0u8G', type: 'LARGE_TEXT' },
      { label: 'Must Haves', id: 'AysRDNDmW7NEmgkxG0Pc', type: 'LARGE_TEXT' },
      { label: 'Second Choice Must Haves', id: 'MHQP9pQgsvadprNyXCIy', type: 'LARGE_TEXT' },
      { label: 'Previously Viewed Properties', id: 'XITF19lX0YYapZCBT23E', type: 'LARGE_TEXT' },
      { label: 'Potential Properties', id: '2GkoU8Lh72AC5BwPSFzf', type: 'LARGE_TEXT' },
      { label: 'Property Identified', id: 'raEuLUqKopdXzxvIreDU', type: 'LARGE_TEXT' },
      { label: 'CMA Sent?', id: 'daYmzLY5IFA9g8n09ONs', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Flood', id: 'Lyv7eAn1tBgDzpToEgdf', type: 'FILE_UPLOAD', multiple: true },
      { label: 'Bushfire', id: 'ccHSnDHKJFi7PZOtn9zt', type: 'FILE_UPLOAD', multiple: true },
      { label: 'Heritage', id: 'JNxCzxrxifroeclObyRB', type: 'FILE_UPLOAD', multiple: true },
      { label: 'Title Search', id: 'wapXPv1hnCYDpDK1vfTa', type: 'LARGE_TEXT' },
      { label: 'Mortgage Broker Check Complete', id: 'zVVmbafhz3TZ1xfOK9yj', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Contract Sent to Solicitor', id: 'txxrIggN291g9OISLz3y', type: 'LARGE_TEXT' },
      { label: 'Offer received by real estate agent', id: 'm9i7HQXWY17PfBBFoOwc', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Full Name (Client 2)', id: 'wHB4bJhT9kuFPNAHMygP', type: 'TEXT' },
      { label: 'Address (Client 2)', id: '634PeulkBMxDwi5Mw9tf', type: 'LARGE_TEXT' },
      { label: 'Full Name (Client 3)', id: 'NcZ9Q0kt2Um0idKhmIhM', type: 'TEXT' },
      { label: 'Phone (Client 2)', id: 'jEH869tIk7awVG3y7L62', type: 'PHONE' },
      { label: 'Phone (Client 3)', id: '7Jde9fNNqL8K9XHCy7u5', type: 'PHONE' },
      { label: 'Alternate Number (Client 2)', id: 'OSkhPsIb5CaLsfHFVVVl', type: 'PHONE' },
      { label: 'Alternate Number (Client 3)', id: 'IKAkpbKPUQfPDGqml4U9', type: 'PHONE' },
      { label: 'Email', id: 'rGl3o463R2k6pHA2sUTr', type: 'TEXT' },
      { label: 'Alternate email (Client 2)', id: 'BrLRYmiETzuMOpZcJoAj', type: 'TEXT' },
      { label: 'Alternate email (Client 3)', id: 'I0XR6vaXZl9bDrgbClFn', type: 'TEXT' },
      { label: 'Notes (Client 2)', id: '6G3biDu17n4DTjb3bT4Y', type: 'LARGE_TEXT' },
      { label: 'Notes (Client 3)', id: 'hH7IcmQZgEwHzIjFJB6j', type: 'LARGE_TEXT' },
      { label: 'Upload DL/Passport (Client 2)', id: 'MjyKkWTESS8hNXmjVGwo', type: 'FILE_UPLOAD' },
      { label: 'Upload DL/Passport (Client 3)', id: '2gwL1Xt4gpLXPvIq8l0X', type: 'FILE_UPLOAD' },
      { label: 'Citizenship Status (Client 2)', id: '6Kkzjrfw2H9PnKbrHfxZ', type: 'TEXT' },
      { label: 'Citizenship Status (Client 3)', id: 'sLy2EQaKQkHZvTvQc0OS', type: 'TEXT' },
      { label: 'REIQ Checklist (Client 2)', id: 'OfCZ3qfSOkcjb8JXG7Nj', type: 'FILE_UPLOAD' },
      { label: 'REIQ Checklist (Client 3)', id: '5QyH4ryvNdDopxkLa1pT', type: 'FILE_UPLOAD' },
      { label: 'Address (Client 3)', id: '0TR2XsNuizgdI43JuI9X', type: 'LARGE_TEXT' },
      { label: 'Email (Client 3)', id: 'zBRgbclelurPoN84ZqRX', type: 'TEXT' },
      { label: 'Additional Persons Driver’s Licenses', id: 'bxUENGu1BODoeX4zcbyQ', type: 'FILE_UPLOAD', multiple: true },
      { label: 'Additional Persons Citizenship Certificates', id: 'WFc5m6oTaIRU6QKQVlxn', type: 'FILE_UPLOAD', multiple: true }
    ];

    function openModal() {
      document.getElementById('modal').classList.add('show');
      setCategory('leads');
      loadContacts();
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
      closeForm();
    }

    function closeForm() {
      document.getElementById('contact-form').style.display = 'none';
      document.getElementById('contact-list').style.display = 'block';
      document.getElementById('new-contact-btn').style.display = 'block';
    }

    function setCategory(category) {
      closeForm();
      activeCategory = category;
      allContacts = [];
      document.getElementById('new-contact-btn').style.display = 'block';
      document.querySelectorAll('.sidebar button').forEach(btn => {
        btn.classList.remove('bg-gold', 'text-white');
        btn.classList.add('bg-dark-green', 'text-white');
      });
      const activeBtn = document.querySelector(`.sidebar button[onclick="setCategory('${category}')"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-dark-green', 'text-white');
        activeBtn.classList.add('bg-gold', 'text-white');
      }
      document.getElementById('change-to-customer-btn').style.display = category === 'leads' ? 'block' : 'none';
      loadContacts();
    }

    async function loadContacts() {
      const tag = activeCategory === 'leads' ? 'new lead' : activeCategory === 'customers' ? 'customer' : activeCategory.toLowerCase();
      currentTag = tag;
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(tag)}`;
      document.getElementById('contact-list').innerHTML = '<p class="text-gray-600 text-center py-4">Loading contacts...</p>';
      const startTime = Date.now();
      try {
        const response = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        allContacts = data.contacts || (data.contact ? [data.contact] : []);
        const filteredContacts = allContacts.filter(contact => contact.tags && contact.tags.includes(tag));
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, 2000 - elapsedTime);
        await new Promise(resolve => setTimeout(resolve, remainingTime));
        displayContacts(filteredContacts);
      } catch (error) {
        console.error('Error loading contacts:', error);
        const elapsedTime = Date.now() - startTime;
        const remainingTime = Math.max(0, 2000 - elapsedTime);
        await new Promise(resolve => setTimeout(resolve, remainingTime));
        document.getElementById('contact-list').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contacts.</p>';
      }
    }

    function displayContacts(contacts) {
      const list = document.getElementById('contact-list');
      list.innerHTML = contacts.length === 0 ? '<p class="text-gray-600 text-center py-4">No contacts found.</p>' : '';
      contacts.forEach(contact => {
        const firstName = contact.firstName || 'Unknown';
        const lastName = contact.lastName || '';
        const email = contact.email || 'No email';
        const phone = contact.phone || 'No phone';
        const contactId = contact.id;
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100';
        li.innerHTML = `
          <div class="flex items-center justify-center space-x-2">
            <input type="checkbox" class="contact-checkbox" data-id="${contactId}">
            <div class="flex" style="width:20vw; text-align:justify;">
              <span class="text-dark-green font-medium">${firstName} ${lastName}</span>
            </div>
            <div class="flex" style="width:20vw; text-align:justify;">
              <span class="text-dark-green font-medium ml-5">${email}</span>
            </div>
            <div class="flex" style="width:20vw; text-align:justify;">
              <span class="text-dark-green font-medium ml-5">${phone}</span>
            </div>
          </div>
        `;
        list.appendChild(li);
      });
      document.querySelectorAll('.contact-checkbox').forEach(cb => {
        cb.addEventListener('change', toggleActionBar);
      });
    }

    function toggleActionBar() {
      const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
      selectedContacts.clear();
      checkboxes.forEach(cb => selectedContacts.add(cb.dataset.id));
      const buttons = document.querySelectorAll('#action-bar button');
      buttons.forEach(btn => {
        btn.disabled = selectedContacts.size === 0;
      });
      if (activeCategory === 'leads') {
        document.getElementById('change-to-customer-btn').style.display = selectedContacts.size > 0 ? 'block' : 'none';
      }
    }

    function searchContacts() {
      const term = document.getElementById('search-input').value.toLowerCase();
      const filteredContacts = allContacts.filter(contact =>
        `${contact.firstName || ''} ${contact.lastName || ''}`.toLowerCase().includes(term) &&
        contact.tags && contact.tags.includes(currentTag)
      );
      displayContacts(filteredContacts);
    }

    async function bulkDelete() {
      if (!confirm('Are you sure you want to delete selected contacts?')) return;
      const deletePromises = Array.from(selectedContacts).map(id => deleteContact(id));
      await Promise.all(deletePromises);
      selectedContacts.clear();
      toggleActionBar();
      loadContacts();
    }

    async function deleteContact(contactId) {
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return true;
      } catch (error) {
        console.error('Error deleting contact:', error);
        alert('Error deleting contact. Please try again.');
        return false;
      }
    }

    async function bulkLoadContacts() {
      if (selectedContacts.size > 1) {
        alert('Please select only one contact to view/edit.');
        return;
      }
      const contactId = Array.from(selectedContacts)[0];
      loadContact(contactId);
    }

    async function bulkAddNote() {
      const note = prompt('Enter your note for selected contacts:');
      if (!note) return;
      const notePromises = Array.from(selectedContacts).map(id => addNote(id, note));
      await Promise.all(notePromises);
      selectedContacts.clear();
      toggleActionBar();
    }

    async function addNote(contactId, note) {
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}/notes`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ body: note })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return true;
      } catch (error) {
        console.error('Error adding note:', error);
        alert('Error adding note. Please try again.');
        return false;
      }
    }

    async function bulkChangeToCustomer() {
      const changePromises = Array.from(selectedContacts).map(id => changeToCustomer(id));
      await Promise.all(changePromises);
      selectedContacts.clear();
      toggleActionBar();
      setCategory('customers');
    }

    function extractFileInfo(fieldValue) {
      if (!fieldValue || typeof fieldValue !== 'object') return [];
      return Object.entries(fieldValue).map(([uuid, fileInfo]) => ({
        url: fileInfo.url || '#',
        name: fileInfo.meta?.originalname || 'Unnamed File'
      }));
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}&include=customFields`;
      try {
        const response = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        const contact = data.contact || data;
        console.log('Single Contact Response:', JSON.stringify(contact, null, 2));

        document.getElementById('contact-list').style.display = 'none';
        document.getElementById('new-contact-btn').style.display = 'none';
        document.getElementById('contact-form').style.display = 'block';

        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('form-buttons').innerHTML = '';

        const customFieldValues = contact.customField || [];
        const fieldMap = customFieldValues.reduce((map, cf) => {
          map[cf.id] = cf.value;
          return map;
        }, {});

        const additionalPersons = fieldMap[additionalPersonsId] ? JSON.parse(fieldMap[additionalPersonsId]) : [];
        personCount = 1;
        const additionalPersonsContainer = document.getElementById('additional-persons');
        additionalPersonsContainer.innerHTML = '';

        if (activeCategory === 'customers') {
          const addPersonBtn = document.createElement('button');
          addPersonBtn.type = 'button';
          addPersonBtn.className = 'button bg-gold text-white px-4 py-2 rounded-lg';
          addPersonBtn.textContent = '+ Add Person';
          addPersonBtn.onclick = addPerson;
          document.getElementById('form-buttons').appendChild(addPersonBtn);

          const driversLicenses = extractFileInfo(fieldMap[driversLicenseFieldId]);
          const citizenshipCerts = extractFileInfo(fieldMap[citizenshipCertFieldId]);

          additionalPersons.reverse().forEach((person, index) => {
            personCount++;
            const personDiv = document.createElement('div');
            personDiv.className = 'person-section mt-4';
            personDiv.innerHTML = `
              <h3 class="text-lg font-semibold text-dark-green">Person ${personCount}</h3>
              <div class="form-group">
                <label class="block font-medium mb-1">Name:</label>
                <input type="text" id="person_${personCount}_name" value="${person.name || ''}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
              </div>
              <div class="form-group">
                <label class="block font-medium mb-1">Email:</label>
                <input type="email" id="person_${personCount}_email" value="${person.email || ''}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
              </div>
              <div class="form-group">
                <label class="block font-medium mb-1">Phone:</label>
                <input type="tel" id="person_${personCount}_phone" value="${person.phone || ''}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
              </div>
              <div class="form-group">
                <label class="block font-medium mb-1">Driver’s License:</label>
                <p class="file-preview mb-2">${driversLicenses.length > 0 ? driversLicenses.map(file => `<a href="${file.url}" target="_blank" class="text-gold hover:underline">${file.name}</a>`).join(', ') : 'No file uploaded'}</p>
                <input type="file" id="person_${personCount}_dl" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" multiple>
              </div>
              <div class="form-group">
                <label class="block font-medium mb-1">Citizenship Certificate:</label>
                <p class="file-preview mb-2">${citizenshipCerts.length > 0 ? citizenshipCerts.map(file => `<a href="${file.url}" target="_blank" class="text-gold hover:underline">${file.name}</a>`).join(', ') : 'No file uploaded'}</p>
                <input type="file" id="person_${personCount}_citizenship" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" multiple>
              </div>
            `;
            additionalPersonsContainer.appendChild(personDiv);
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.textContent = 'Remove Person';
            deleteBtn.className = 'text-red-500 ml-4';
            deleteBtn.onclick = () => personDiv.remove();
            personDiv.querySelector('h3').appendChild(deleteBtn);
            additionalPersonsContainer.appendChild(personDiv);
          });
        }

        const standardFields = [
          { label: 'First Name', key: 'firstName', id: 'firstName', value: contact.firstName || '', required: true },
          { label: 'Last Name', key: 'lastName', id: 'lastName', value: contact.lastName || '', required: true },
          { label: 'Email', key: 'email', id: 'email', value: contact.email || '', type: 'email' },
          { label: 'Phone', key: 'phone', id: 'phone', value: contact.phone || '', type: 'tel' },
        ];

        document.getElementById('standard-fields').innerHTML = `
          <h3 class="text-lg font-semibold text-dark-green">Main Contact</h3>
          ${standardFields.map(field => `
            <div class="form-group">
              <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
              <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
            </div>
          `).join('')}
        `;

        const customFieldsDiv = document.getElementById('custom-fields');
        if (activeCategory === 'customers') {
          let addressValue = fieldMap['xiMyfob6XvYdCJ2mUFvs'] || '';
          const hasCountry = addressValue.match(/,\s*(AU|Australia)$/i);
          const components = [
            contact.address1 && !addressValue.includes(contact.address1) ? contact.address1 : '',
            contact.city && !addressValue.includes(contact.city) ? contact.city : '',
            contact.state && !addressValue.includes(contact.state) ? contact.state : '',
            contact.postalCode && !addressValue.includes(contact.postalCode) ? contact.postalCode : '',
            !hasCountry && !contact.country ? 'AU' : (contact.country && !addressValue.includes(contact.country) ? contact.country : '')
          ].filter(v => v).join(', ');
          if (components && !addressValue) addressValue = components;
          else if (components) addressValue = [addressValue, components].filter(v => v).join(', ').trim();

          customFieldsDiv.innerHTML = customerCustomFields.filter(field => field.id !== 'PjQ2rir2JEogi9aUAP2s' && field.id !== driversLicenseFieldId && field.id !== citizenshipCertFieldId).map(field => {
            let fieldValue = fieldMap[field.id] || '';
            if (field.label === 'Full Name') fieldValue = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
            if (field.label === 'Address') fieldValue = addressValue;

            if (field.type === 'FILE_UPLOAD') {
              let filePreviews = 'No file uploaded';
              if (fieldValue && typeof fieldValue === 'object') {
                const fileEntries = Object.entries(fieldValue);
                if (fileEntries.length > 0) {
                  filePreviews = fileEntries.map(([uuid, fileInfo]) => {
                    const originalName = fileInfo.meta?.originalname || 'Unnamed File';
                    const fileUrl = fileInfo.url || '#';
                    return `<a href="${fileUrl}" target="_blank" class="text-gold hover:underline">${originalName}</a>`;
                  }).join(', ');
                }
              }
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <p class="file-preview mb-2">${filePreviews}</p>
                  <input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" ${field.multiple ? 'multiple' : ''}>
                </div>
              `;
            } else if (field.type === 'LARGE_TEXT') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  <textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">${fieldValue}</textarea>
                </div>
              `;
            } else if (field.type === 'SINGLE_OPTIONS') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  <select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                    <option value="">Select an option</option>
                    ${field.options.map(option => `<option value="${option}" ${fieldValue === option ? 'selected' : ''}>${option}</option>`).join('')}
                  </select>
                </div>
              `;
            } else if (field.type === 'RADIO') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4">
                      <input type="radio" name="custom_${field.id}" value="${option}" ${fieldValue === option ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'MULTIPLE_OPTIONS' || field.type === 'CHECKBOX') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4 mb-2">
                      <input type="checkbox" name="custom_${field.id}" value="${option}" ${Array.isArray(fieldValue) && fieldValue.includes(option) ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'DATE') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  <input type="date" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            } else if (field.type === 'PHONE') {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  <input type="tel" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            } else {
              return `
                <div class="form-group">
                  <label class="block font-medium mb-1">${field.label}:</label>
                  <input type="text" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            }
          }).join('');
          console.log('Custom Field IDs:', customerCustomFields.map(field => field.id));
        } else if (activeCategory !== 'leads' && activeCategory !== 'customers') {
          const nicheValue = contact.customField?.find(cf => cf.id === 'PjQ2rir2JEogi9aUAP2s')?.value || '';
          customFieldsDiv.innerHTML = `
            <div class="form-group">
              <label class="block text-dark-green font-medium mb-1">Client Niche:</label>
              <input type="text" id="custom_PjQ2rir2JEogi9aUAP2s" value="${nicheValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
            </div>
          `;
          console.log('Custom Field IDs:', ['PjQ2rir2JEogi9aUAP2s']);
        } else {
          customFieldsDiv.innerHTML = '';
        }
      } catch (error) {
        console.error('Error loading contact:', error);
        document.getElementById('contact-form').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contact.</p>';
      }
    }

    function addPerson() {
      personCount++;
      const additionalPersonsContainer = document.getElementById('additional-persons');
      const personDiv = document.createElement('div');
      personDiv.className = 'person-section mt-4';
      personDiv.innerHTML = `
        <h3 class="text-lg font-semibold text-dark-green">Person ${personCount}</h3>
        <div class="form-group">
          <label class="block font-medium mb-1">Name:</label>
          <input type="text" id="person_${personCount}_name" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
        </div>
        <div class="form-group">
          <label class="block font-medium mb-1">Email:</label>
          <input type="email" id="person_${personCount}_email" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
        </div>
        <div class="form-group">
          <label class="block font-medium mb-1">Phone:</label>
          <input type="tel" id="person_${personCount}_phone" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
        </div>
        <div class="form-group">
          <label class="block font-medium mb-1">Driver’s License:</label>
          <p class="file-preview mb-2">No file uploaded</p>
          <input type="file" id="person_${personCount}_dl" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" multiple>
        </div>
        <div class="form-group">
          <label class="block font-medium mb-1">Citizenship Certificate:</label>
          <p class="file-preview mb-2">No file uploaded</p>
          <input type="file" id="person_${personCount}_citizenship" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" multiple>
        </div>
      `;
      additionalPersonsContainer.insertBefore(personDiv, additionalPersonsContainer.firstChild);
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Remove Person';
      deleteBtn.className = 'text-red-500 ml-4';
      deleteBtn.onclick = () => personDiv.remove();
      personDiv.querySelector('h3').appendChild(deleteBtn);
      additionalPersonsContainer.appendChild(personDiv);
    }

    async function uploadFile(file, fieldId) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('contactId', selectedContactId || '');
      formData.append('fieldId', fieldId);
      formData.append('locationId', locationId);

      const response = await fetch('https://custom-menu-backend-661398661b06.herokuapp.com/upload', {
        method: 'POST',
        body: formData,
      });
      if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);

      const result = await response.json();
      // result.value is the full map { uuid: {meta,url,documentId}, … }
      const map = result.value || result.uploads || {};
      return Object.entries(map).map(([uuid, info]) => ({
        uuid,
        meta: info.meta,
        url: info.url,
        documentId: info.documentId
      }));
    }


    async function showNewContactForm() {
      // selectedContactId = null;
      const standardFields = [
        { label: 'First Name', key: 'firstName', id: 'firstName', value: '', required: true },
        { label: 'Last Name', key: 'lastName', id: 'lastName', value: '', required: true },
        { label: 'Email', key: 'email', id: 'email', value: '', type: 'email' },
        { label: 'Phone', key: 'phone', id: 'phone', value: '', type: 'tel' },
      ];

      // document.getElementById('additional-persons').innerHTML = '';

      document.getElementById('standard-fields').innerHTML = `
        <h3 class="text-lg font-semibold text-dark-green">Main Contact</h3>
        ${standardFields.map(field => `
          <div class="form-group">
            <label class="block font-medium mb-1">${field.label}:</label>
            <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
          </div>
        `).join('')}
      `;

      const customFieldsDiv = document.getElementById('custom-fields');
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('form-buttons').innerHTML = '';
      const personsSection = document.getElementById('persons-section'); 
      const customersSection = document.getElementById('customers-section'); 


      if (activeCategory === 'customers') {
        personsSection.style.display = 'block';

        const addPersonBtn = document.createElement('button');
        addPersonBtn.type = 'button';
        addPersonBtn.className = 'button bg-gold text-white px-4 py-2 rounded-lg';
        addPersonBtn.textContent = '+ Add Person';
        addPersonBtn.onclick = addPerson;
        document.getElementById('form-buttons').appendChild(addPersonBtn);
        

        customFieldsDiv.innerHTML = customerCustomFields.filter(field => field.id !== 'PjQ2rir2JEogi9aUAP2s' && field.id !== driversLicenseFieldId && field.id !== citizenshipCertFieldId).map(field => `
          <div class="form-group">
            <label class="block font-medium mb-1">${field.label}:</label>
            ${field.type === 'FILE_UPLOAD' ?
            `<input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg" ${field.multiple ? 'multiple' : ''}>` :
            field.type === 'LARGE_TEXT' ?
              `<textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold"></textarea>` :
              field.type === 'SINGLE_OPTIONS' ?
                `<select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                <option value="">Select an option</option>
                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>` :
                field.type === 'RADIO' ?
                  field.options.map(option => `
                <label class="inline-flex items-center mr-4 mb-2">
                  <input type="radio" name="custom_${field.id}" value="${option}" class="mr-2">
                  <span>${option}</span>
                </label>
              `).join('') :
                  field.type === 'MULTIPLE_OPTIONS' || field.type === 'CHECKBOX' ?
                    field.options.map(option => `
                <label class="inline-flex items-center mr-4 mb-2">
                  <input type="checkbox" name="custom_${field.id}" value="${option}" class="mr-2">
                  <span>${option}</span>
                </label>
              `).join('') :
                    field.type === 'DATE' ?
                      `<input type="date" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">` :
                      field.type === 'PHONE' ?
                        `<input type="tel" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">` :
                        `<input type="text" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">`}
          </div>
        `).join('');
        console.log('Custom Field IDs for new contact:', customerCustomFields.map(field => field.id));
      } else if (activeCategory !== 'leads' && activeCategory !== 'customers') {
        personsSection.style.display = 'none';
        customFieldsDiv.innerHTML = `
          <div class="form-group">
            <label class="block text-dark-green font-medium mb-1">Client Niche:</label>
            <input type="text" id="custom_PjQ2rir2JEogi9aUAP2s" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
          </div>
        `;
        console.log('Custom Field IDs for new contact:', ['PjQ2rir2JEogi9aUAP2s']);
      } else {
        personsSection.style.display = 'none';
        customFieldsDiv.innerHTML = '';
      }
      document.getElementById('contact-list').style.display = 'none';
      document.getElementById('new-contact-btn').style.display = 'none';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.getElementById('contact-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      const loader = document.getElementById('form-loader');
      loader.style.display = 'inline-block';

      // 1. Fetch existing contact if editing
      let contactToEdit = null;
      if (selectedContactId) {
        const res = await fetch(
          `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}&include=customFields`,
          { headers: { Authorization: `Bearer ${apiKey}` } }
        );
        const json = await res.json();
        contactToEdit = json.contact || json;
      }

      // 2. Build base payload
      const data = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [
          activeCategory === 'leads'
            ? 'new lead'
            : activeCategory === 'customers'
              ? 'customer'
              : activeCategory.toLowerCase()
        ],
        customField: []
      };

      // 3. Add non-file custom fields
      if (activeCategory === 'customers') {
        // a) Additional persons
        const persons = [];
        for (let i = 2; i <= personCount; i++) {
          const name = document.getElementById(`person_${i}_name`)?.value;
          if (!name) continue;
          persons.push({
            name,
            email: document.getElementById(`person_${i}_email`)?.value || '',
            phone: document.getElementById(`person_${i}_phone`)?.value || ''
          });
        }
        if (persons.length) {
          data.customField.push({ id: additionalPersonsId, value: JSON.stringify(persons.reverse()) });
        }
        // b) Other non-file fields
        customerCustomFields
          .filter(field => field.type !== 'FILE_UPLOAD')
          .forEach(field => {
            let value = '';
            if (field.type === 'SINGLE_OPTIONS') {
              value = document.getElementById(`custom_${field.id}`)?.value || '';
            } else if (field.type === 'RADIO') {
              value = document.querySelector(`input[name="custom_${field.id}"]:checked`)?.value || '';
            } else if (['MULTIPLE_OPTIONS', 'CHECKBOX'].includes(field.type)) {
              value = Array.from(
                document.querySelectorAll(`input[name="custom_${field.id}"]:checked`)
              ).map(cb => cb.value);
            } else {
              value = document.getElementById(`custom_${field.id}`)?.value || '';
            }
            if (
              (Array.isArray(value) && value.length) ||
              (!Array.isArray(value) && value !== '')
            ) {
              data.customField.push({ id: field.id, value });
            }
          });

        // 4. Handle file uploads and merging
        const fileUploadPromises = customerCustomFields
          .filter(field => field.type === 'FILE_UPLOAD')
          .map(async field => {
            // retrieve existing value for this field
            const existingField = contactToEdit
              ? contactToEdit.customField.find(cf => cf.id === field.id)
              : null;
            // keep only UUID keys
            const currentFiles = {};
            if (existingField && typeof existingField.value === 'object') {
              Object.entries(existingField.value).forEach(([k, v]) => {
                if (k.includes('-')) currentFiles[k] = v;
              });
            }

            // file inputs: persons or general
            const inputs = [];
            if ([driversLicenseFieldId, citizenshipCertFieldId].includes(field.id)) {
              for (let i = 2; i <= personCount; i++) {
                inputs.push(
                  field.id === driversLicenseFieldId
                    ? document.getElementById(`person_${i}_dl`)
                    : document.getElementById(`person_${i}_citizenship`)
                );
              }
            } else {
              inputs.push(document.getElementById(`custom_${field.id}_new`));
            }

            // upload each file and merge
            for (const input of inputs) {
              if (input?.files?.length) {
                for (const file of input.files) {
                  const uploaded = await uploadFile(file, field.id);
                  if (uploaded?.uuid) {
                    currentFiles[uploaded.uuid] = {
                      meta: uploaded.meta,
                      url: uploaded.url,
                      documentId: uploaded.documentId
                    };
                  }
                }
              }
            }

            // push merged value
            if (Object.keys(currentFiles).length) {
              data.customField.push({ id: field.id, value: currentFiles });
            }
          });

        await Promise.all(fileUploadPromises);
      }
      else if (activeCategory !== 'leads') {
        const nicheValue = document.getElementById('custom_PjQ2rir2JEogi9aUAP2s')?.value || '';
        if (nicheValue) data.customField.push({ id: 'PjQ2rir2JEogi9aUAP2s', value: nicheValue });
      }

      // 5. Clean and submit
      data.customField = data.customField.filter(
        cf =>
          cf.value !== '' && (!Array.isArray(cf.value) || cf.value.length > 0)
      );

      console.log('Request Body:', JSON.stringify(data, null, 2));

      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;

      try {
        const response = await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(await response.text());
        console.log('Save Response:', await response.json());
        alert(selectedContactId ? 'Updated!' : 'Created!');
        closeForm(); loadContacts();
      } catch (err) {
        console.error('Save error:', err);
        alert('Error saving contact.');
      } finally {
        loader.style.display = 'none';
      }
    });

    async function changeToCustomer(contactId) {
      selectedContactId = contactId;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');

        const updateResponse = await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        if (!updateResponse.ok) throw new Error(`HTTP error! Status: ${updateResponse.status}`);
        console.log('Tag Update Response:', await updateResponse.json());
        return true;
      } catch (error) {
        console.error('Error changing to customer:', error);
        alert('Error changing contact to Customer.');
        return false;
      }
    }
    document.querySelectorAll('.section').forEach(section => {
      const header = section.querySelector('.section-header');
      const body = section.querySelector('.section-body');
      const icon = header.querySelector('.toggle-icon');

      header.addEventListener('click', () => {
        const isHidden = body.classList.toggle('hidden');
        icon.classList.toggle('fa-circle-down', isHidden === false);
        icon.classList.toggle('fa-circle-right', isHidden === true);
      });
    });


  </script>
</body>

</html>