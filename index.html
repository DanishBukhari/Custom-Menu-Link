<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal {
      transition: opacity 0.3s ease-in-out;
      display: none;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      padding: 0;
      overflow: hidden;
      display: flex;
      background-color: #fff;
      margin-top: 5px;
    }
    .modal-open .modal-content {
      transform: translateY(0);
    }
    .button {
      transition: background-color 0.3s ease, transform 0.1s ease;
      color: white;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .form-group input, .form-group textarea, .form-group select {
      transition: border-color 0.3s ease;
      font-size: 16px;
      padding: 12px;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: #d0a547;
      outline: none;
    }
    .form-actions {
      position: sticky;
      bottom: 0;
      background-color: #fff;
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      z-index: 10;
    }
    .loader {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-left: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .bg-gold { background-color: #91712e; }
    .text-gold { color: #d0a547; }
    .bg-dark-green { background-color: #d0a547; }
    .text-dark-green { color: #ffffff; }
    .sidebar {
      width: 250px;
      background-color: #304528;
      padding: 20px;
      border-right: 1px solid #e5e7eb;
      overflow-y: hidden;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .sidebar ul li {
      margin-bottom: 10px;
    }
    .sidebar ul li button {
      width: 100%;
      text-align: left;
      padding: 10px;
      border-radius: 4px;
    }
    .subcategory-list {
      margin-left: 15px;
      margin-top: 5px;
    }
    .search-bar {
      width: 200px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center" onload="openModal()">
  <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="modal-content">
      <div class="sidebar">
        <h3 class="text-2xl font-semibold text-dark-green mb-4">Categories</h3>
        <ul>
          <li>
            <button class="bg-dark-green text-white button px-4 py-2 rounded-lg" onclick="toggleClients()">Clients</button>
            <ul id="subcategory-list" class="hidden">
              <li><button class="bg-dark-green text-white button px-3 py-1 rounded-lg" onclick="setSubcategory('leads')">Leads</button></li>
              <li><button class="bg-dark-green text-white button px-3 py-1 rounded-lg" onclick="setSubcategory('customers')">Customers</button></li>
            </ul>
          </li>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg" onclick="setCategory('real estate')">Real Estate</button></li>
          <li><button class="bg-dark-green text-white button px-4 py-2 rounded-lg" onclick="setCategory('lawyers')">Lawyers</button></li>
          <li><button class="bg-dark-green text-white px-4 py-2 rounded-lg button" onclick="setCategory('tradies')">Tradies</button></li>
          <li><button class="bg-dark-green text-white px-4 py-2 rounded-lg" onclick="setCategory('finance')">Finance</button></li>
        </ul>
      </div>
      <div class="main-content">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-dark-green">Network Contacts</h2>
          <input type="text" id="search-input" placeholder="Search clients..." class="search-bar p-2 border border-gray-300 rounded-lg text-dark-green" oninput="searchContacts()">
        </div>
        <div id="contact-list" class="bg-gray-50 p-4 rounded-lg"></div>
        <button id="new-contact-btn" class="button bg-gold text-dark-green px-4 py-2 rounded-lg mt-2 hover:bg-yellow-600" style="display: none;" onclick="showNewContactForm()">New Contact</button>
        <div id="contact-form" class="mt-4" style="display: none;">
          <h3 id="form-title" class="text-xl font-semibold text-dark-green mb-4"></h3>
          <form id="contact-form-element">
            <div id="standard-fields" class="space-y-4"></div>
            <div id="custom-fields" class="space-y-4 mt-4"></div>
            <div id="niche-field" class="form-group" style="display: none;">
              <label class="block text-dark-green font-medium mb-1">Client Niche:</label>
              <input type="text" id="niche" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
            </div>
            <div class="form-actions flex space-x-2">
              <button type="submit" class="button bg-dark-green text-white px-6 py-2 rounded-lg hover:bg-green-800 flex items-center">
                Save
                <span id="form-loader" class="loader"></span>
              </button>
              <button type="button" class="button bg-gray-300 text-dark-green px-6 py-2 rounded-lg hover:bg-gray-400" onclick="closeForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IllnUUp0OHppcGhlQVNtTXo2SEpmIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4ODA3OTc5ODk1LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9._deFuXYQdzXwzy8T_9kzzA_CxIX_pPnaJKcgwaetKHg";
    const locationId = "YgQJt8zipheASmMz6HJf";
    let activeCategory = 'clients';
    let activeSubcategory = 'leads';
    let selectedContactId = null;
    let allContacts = [];

    function openModal() {
      document.getElementById('modal').classList.add('show');
      setCategory('clients');
      setSubcategory('leads');
      loadContacts();
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
      closeForm();
    }

    function closeForm() {
      document.getElementById('contact-form').style.display = 'none';
    }

    function toggleClients() {
      const dropdown = document.getElementById('subcategory-list');
      dropdown.classList.toggle('hidden');
      if (!dropdown.classList.contains('hidden')) {
        setSubcategory('leads');
      }
    }

    function setCategory(category) {
      closeForm();
      activeCategory = category;
      allContacts = [];
      document.getElementById('subcategory-list').classList.toggle('hidden', category !== 'clients');
      document.getElementById('niche-field').style.display = category !== 'clients' ? 'block' : 'none';
      document.getElementById('new-contact-btn').style.display = category === 'clients' && activeSubcategory === 'leads' ? 'block' : 'none';
      document.querySelectorAll('.sidebar button').forEach(btn => {
        btn.classList.remove('bg-gold', 'text-dark-green');
        btn.classList.add('bg-dark-green', 'text-white');
      });
      const activeBtn = document.querySelector(`.sidebar button[onclick="setCategory('${category}')"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-dark-green', 'text-white');
        activeBtn.classList.add('bg-gold', 'text-dark-green');
      }
      if (category === 'clients') {
        setSubcategory(activeSubcategory || 'leads');
      } else {
        loadContacts();
      }
    }

    function setSubcategory(subcategory) {
      if (activeCategory !== 'clients') return;
      closeForm();
      activeSubcategory = subcategory;
      document.getElementById('new-contact-btn').style.display = subcategory === 'leads' ? 'block' : 'none';
      document.querySelectorAll('#subcategory-list button').forEach(btn => {
        btn.classList.remove('bg-gold', 'text-dark-green');
        btn.classList.add('bg-dark-green', 'text-white');
      });
      const activeBtn = document.querySelector(`#subcategory-list button[onclick="setSubcategory('${subcategory}')"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-dark-green', 'text-white');
        activeBtn.classList.add('bg-gold', 'text-dark-green');
      }
      loadContacts();
    }

    async function loadContacts() {
      const tag = activeCategory === 'clients' ? (activeSubcategory === 'leads' ? 'new lead' : 'customer') : activeCategory.toLowerCase();
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(tag)}`;
      try {
        document.getElementById('contact-list').innerHTML = '<p class="text-gray-600 text-center py-4">Loading contacts...</p>';
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        allContacts = data.contacts || (data.contact ? [data.contact] : []);
        displayContacts(allContacts);
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contact-list').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contacts.</p>';
      }
    }

    function displayContacts(contacts) {
      const list = document.getElementById('contact-list');
      list.innerHTML = contacts.length === 0 ? '<p class="text-gray-600 text-center py-4">No contacts found.</p>' : '';
      contacts.forEach(contact => {
        const firstName = contact.firstName || 'Unknown';
        const lastName = contact.lastName || '';
        const contactId = contact.id;
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100';
        li.innerHTML = `
          <span class="text-dark-green">${firstName} ${lastName}</span>
          <div class="space-x-2">
            <button class="button bg-gold text-dark-green px-3 py-1 rounded-lg hover:bg-yellow-600" onclick="loadContact('${contactId}')">View</button>
            <button class="button bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600" onclick="deleteContact('${contactId}')">Delete</button>
            <button class="button bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600" onclick="addNote('${contactId}')">Add Note</button>
            ${activeCategory === 'clients' && activeSubcategory === 'leads' ? `<button class="button bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600" onclick="changeToCustomer('${contactId}')">Change to Customer</button>` : ''}
          </div>
        `;
        list.appendChild(li);
      });
    }

    function searchContacts() {
      const term = document.getElementById('search-input').value.toLowerCase();
      const filteredContacts = allContacts.filter(contact => 
        `${contact.firstName || ''} ${contact.lastName || ''}`.toLowerCase().includes(term)
      );
      displayContacts(filteredContacts);
    }

    async function deleteContact(contactId) {
      if (!confirm('Are you sure you want to delete this contact?')) return;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        alert('Contact deleted successfully!');
        loadContacts();
      } catch (error) {
        console.error('Error deleting contact:', error);
        alert('Error deleting contact. Please try again.');
      }
    }

    async function addNote(contactId) {
      const note = prompt('Enter your note:');
      if (!note) return;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}/notes`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${apiKey}`, 
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({ body: note })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        alert('Note added successfully!');
      } catch (error) {
        console.error('Error adding note:', error);
        alert('Error adding note. Please try again.');
      }
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}&include=customFields`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        const contact = data.contact || data;

        const standardFields = [
          { label: 'First Name', key: 'firstName', id: 'firstName', value: contact.firstName || '', required: true },
          { label: 'Last Name', key: 'lastName', id: 'lastName', value: contact.lastName || '', required: true },
          { label: 'Email', key: 'email', id: 'email', value: contact.email || '', type: 'email' },
          { label: 'Phone', key: 'phone', id: 'phone', value: contact.phone || '', type: 'tel' },
        ];

        document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
          <div class="form-group">
            <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
            <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
          </div>
        `).join('');

        const customFieldsDiv = document.getElementById('custom-fields');
        if (activeCategory === 'clients' && activeSubcategory === 'customers') {
          const customFieldValues = contact.customField || [];
          const fieldMap = customFieldValues.reduce((map, cf) => {
            const value = cf.value && typeof cf.value === 'object' ? (cf.value[Object.keys(cf.value)[0]]?.url || cf.value) : cf.value;
            map[cf.id] = value || '';
            return map;
          }, {});

          let addressValue = fieldMap['xiMyfob6XvYdCJ2mUFvs'] || '';
          const hasCountry = addressValue.match(/,\s*(AU|Australia)$/i);
          const components = [
            contact.address1 && !addressValue.includes(contact.address1) ? contact.address1 : '',
            contact.city && !addressValue.includes(contact.city) ? contact.city : '',
            contact.state && !addressValue.includes(contact.state) ? contact.state : '',
            contact.postalCode && !addressValue.includes(contact.postalCode) ? contact.postalCode : '',
            !hasCountry && !contact.country ? 'AU' : (contact.country && !addressValue.includes(contact.country) ? contact.country : '')
          ].filter(v => v).join(', ');
          if (components && !addressValue) addressValue = components;
          else if (components) addressValue = [addressValue, components].filter(v => v).join(', ').trim();

          customFieldsDiv.innerHTML = customerCustomFields.map(field => {
            let fieldValue = fieldMap[field.id] || '';
            if (field.label === 'Full Name') fieldValue = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
            if (field.label === 'Address') fieldValue = addressValue;

            if (field.type === 'FILE_UPLOAD') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <p class="file-preview mb-2">${fieldValue ? `<a href="${fieldValue}" target="_blank" class="text-gold hover:underline">${fieldValue.split('/').pop()}</a>` : 'No file uploaded'}</p>
                  <input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
              `;
            } else if (field.type === 'LARGE_TEXT') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">${fieldValue}</textarea>
                </div>
              `;
            } else if (field.type === 'SINGLE_OPTIONS') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                    <option value="">Select an option</option>
                    ${field.options.map(option => `<option value="${option}" ${fieldValue === option ? 'selected' : ''}>${option}</option>`).join('')}
                  </select>
                </div>
              `;
            } else if (field.type === 'RADIO') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4">
                      <input type="radio" name="custom_${field.id}" value="${option}" ${fieldValue === option ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'MULTIPLE_OPTIONS') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4 mb-2">
                      <input type="checkbox" name="custom_${field.id}" value="${option}" ${Array.isArray(fieldValue) && fieldValue.includes(option) ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'CHECKBOX') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4 mb-2">
                      <input type="checkbox" name="custom_${field.id}" value="${option}" ${Array.isArray(fieldValue) && fieldValue.includes(option) ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'DATE') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <input type="date" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            } else if (field.type === 'PHONE') {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <input type="tel" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            } else {
              return `
                <div class="form-group">
                  <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
                  <input type="text" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                </div>
              `;
            }
          }).join('');
        } else if (activeCategory !== 'clients') {
          customFieldsDiv.innerHTML = `
            <div class="form-group">
              <label class="block text-dark-green font-medium mb-1">Client Niche:</label>
              <input type="text" id="custom_niche" value="${contact.customField?.find(cf => cf.id === 'niche')?.value || ''}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
            </div>
          `;
        } else {
          customFieldsDiv.innerHTML = '';
        }

        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('contact-form').style.display = 'block';
      } catch (error) {
        console.error('Error loading contact:', error);
        document.getElementById('contact-form').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contact.</p>';
      }
    }

    async function showNewContactForm() {
      selectedContactId = null;
      const standardFields = [
        { label: 'First Name', key: 'firstName', id: 'firstName', value: '', required: true },
        { label: 'Last Name', key: 'lastName', id: 'lastName', value: '', required: true },
        { label: 'Email', key: 'email', id: 'email', value: '', type: 'email' },
        { label: 'Phone', key: 'phone', id: 'phone', value: '', type: 'tel' },
      ];

      document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
        <div class="form-group">
          <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
          <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
        </div>
      `).join('');

      const customFieldsDiv = document.getElementById('custom-fields');
      if (activeCategory === 'clients' && activeSubcategory === 'customers') {
        customFieldsDiv.innerHTML = customerCustomFields.map(field => `
          <div class="form-group">
            <label class="block text-dark-green font-medium mb-1">${field.label}:</label>
            ${field.type === 'FILE_UPLOAD' ? 
              `<input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">` :
            field.type === 'LARGE_TEXT' ? 
              `<textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold"></textarea>` :
            field.type === 'SINGLE_OPTIONS' ? 
              `<select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
                <option value="">Select an option</option>
                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>` :
            field.type === 'RADIO' ? 
              field.options.map(option => `
                <label class="inline-flex items-center mr-4 mb-2">
                  <input type="radio" name="custom_${field.id}" value="${option}" class="mr-2">
                  <span>${option}</span>
                </label>
              `).join('') :
            field.type === 'MULTIPLE_OPTIONS' || field.type === 'CHECKBOX' ? 
              field.options.map(option => `
                <label class="inline-flex items-center mr-4 mb-2">
                  <input type="checkbox" name="custom_${field.id}" value="${option}" class="mr-2">
                  <span>${option}</span>
                </label>
              `).join('') :
            field.type === 'DATE' ? 
              `<input type="date" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">` :
            field.type === 'PHONE' ? 
              `<input type="tel" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">` :
              `<input type="text" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">`}
          </div>
        `).join('');
      } else if (activeCategory !== 'clients') {
        customFieldsDiv.innerHTML = `
          <div class="form-group">
            <label class="block text-dark-green font-medium mb-1">Client Niche:</label>
            <input type="text" id="custom_niche" class="w-full p-2 border border-gray-300 rounded-lg focus:border-gold">
          </div>
        `;
      } else {
        customFieldsDiv.innerHTML = '';
      }
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.getElementById('contact-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      const loader = document.getElementById('form-loader');
      loader.style.display = 'inline-block';
      const data = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [activeCategory === 'clients' ? (activeSubcategory === 'leads' ? 'new lead' : 'customer') : activeCategory.toLowerCase()],
        customField: []
      };

      const addressFields = ['xiMyfob6XvYdCJ2mUFvs', 'city', 'country', 'state', 'postalCode'];
      if (activeCategory === 'clients' && activeSubcategory === 'customers' && addressFields.some(id => document.getElementById(`custom_${id}`))) {
        const address = addressFields.map(id => document.getElementById(`custom_${id}`)?.value || '').filter(v => v).join(', ');
        data.customField.push({ id: 'xiMyfob6XvYdCJ2mUFvs', value: address || '' });
      }

      if (activeCategory === 'clients' && activeSubcategory === 'customers') {
        data.customField = data.customField.concat(await Promise.all(customerCustomFields.map(async field => {
          if (field.type === 'FILE_UPLOAD') {
            const fileInput = document.getElementById(`custom_${field.id}_new`);
            if (fileInput && fileInput.files.length > 0) {
              const formData = new FormData();
              formData.append('file', fileInput.files[0], fileInput.files[0].name);
              formData.append('contactId', selectedContactId || '');
              formData.append('fieldId', field.id);
              formData.append('locationId', locationId);
              try {
                const response = await fetch('https://custom-menu-backend-661398661b06.herokuapp.com/upload', {
                  method: 'POST',
                  body: formData,
                });
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(`Upload failed: ${errorData.error || response.statusText}`);
                }
                const result = await response.json(data);
                if (result.url) {
                  const preview = fileInput.parentElement.querySelector('.file-preview');
                  if (preview) {
                    preview.innerHTML = `<a href="${result.url}" target="_blank" class="text-gold hover:underline">${result.url.split('/').pop()}</a>`;
                  }
                  return { id: result.id, value: result.url };
                }
                throw new Error('Upload failed: No URL returned');
              } catch (error) {
                console.error('File upload error:', error.message);
                return { id: field.id, value: '' };
              }
            }
            return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
          } else if (field.type === 'SINGLE_OPTIONS') {
            const selectElement = document.getElementById(`custom_${field.id}`);
            const value = selectElement ? selectElement.value : '';
            return { id: field.id, value };
          } else if (field.type === 'RADIO') {
            const checkedRadio = document.querySelector(`input[name="custom_${field.id}"]:checked`);
            const value = checkedRadio ? checkedRadio.value : '';
            return { id: field.id, value };
          } else if (field.type === 'MULTIPLE_OPTIONS' || field.type === 'CHECKBOX') {
            const checkboxes = document.querySelectorAll(`input[name="custom_${field.id}"]:checked`);
            const selectedOptions = Array.from(checkboxes).map(cb => cb.value);
            return { id: field.id, value: selectedOptions };
          } else {
            const value = document.getElementById(`custom_${field.id}`)?.value || '';
            return { id: field.id, value };
          }
        })));
        data.customField = data.customField.filter(cf => cf.value !== '' && cf.value.length !== 0);
      } else if (activeCategory !== 'clients') {
        const nicheValue = document.getElementById('custom_niche').value;
        if (nicheValue) {
          data.customField.push({ id: 'niche', value: nicheValue });
        }
      }

      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        console.log('Save Contact Response:', await response.json());
        alert(selectedContactId ? 'Contact updated successfully!' : 'Contact created successfully!');
        closeForm();
        loadContacts();
      } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact. Please try again.');
      } finally {
        loader.style.display = 'none';
      }
    })

    async function changeToCustomer(contactId) {
      selectedContactId = contactId;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');

        const updateResponse = await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        if (!updateResponse.ok) throw new Error(`HTTP error! Status: ${updateResponse.status}`);
        console.log('Tag Update Response:', await updateResponse.json());
        setSubcategory('customers');
        loadContact(contactId);
        alert('Contact changed to Customer successfully!');
      } catch (error) {
        console.error('Error changing to customer:', error);
        alert('Error changing contact to Customer.');
      }
    }
  </script>
</body>
</html>