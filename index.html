<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for additional polish */
    .modal {
      transition: opacity 0.3s ease-in-out;
    }
    .modal-content {
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
    }
    .modal-open .modal-content {
      transform: translateY(0);
    }
    .button {
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .form-group input, .form-group textarea {
      transition: border-color 0.3s ease;
    }
    .form-group input:focus, .form-group textarea:focus {
      border-color: #3b82f6;
      outline: none;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="network-app" class="w-full max-w-7xl p-4">
    <button class="button bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700" onclick="openModal()">Network</button>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" id="modal" style="display: none;">
      <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-800">Network Contacts</h2>
          <span class="close text-3xl text-gray-500 cursor-pointer hover:text-gray-700" onclick="closeModal()">Ã—</span>
        </div>
        <div id="category-buttons" class="flex space-x-2 mb-4">
          <button class="button bg-blue-500 text-white px-4 py-2 rounded-lg active:bg-blue-700" onclick="setCategory('clients')">Clients</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setCategory('real estate')">Real Estate</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setCategory('tradies')">Tradies</button>
        </div>
        <div id="subcategory-buttons" class="flex space-x-2 mb-4" style="display: none;">
          <button class="button bg-blue-500 text-white px-4 py-2 rounded-lg active:bg-blue-700" onclick="setSubcategory('leads')">Leads</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setSubcategory('customers')">Customers</button>
        </div>
        <div id="contact-list" class="bg-gray-50 p-4 rounded-lg"></div>
        <button id="new-contact-btn" class="button bg-green-500 text-white px-4 py-2 rounded-lg mt-2 hover:bg-green-600" style="display: none;" onclick="showNewContactForm()">New Contact</button>
        <div id="contact-form" class="mt-4" style="display: none;">
          <h3 id="form-title" class="text-xl font-semibold text-gray-800 mb-4"></h3>
          <div id="standard-fields" class="space-y-4"></div>
          <div id="custom-fields" class="space-y-4 mt-4"></div>
          <div class="flex space-x-2 mt-4">
            <button type="submit" class="button bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" onclick="document.getElementById('contact-form-element').dispatchEvent(new Event('submit'))">Save</button>
            <button type="button" class="button bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400" onclick="closeForm()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IllnUUp0OHppcGhlQVNtTXo2SEpmIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4ODA3OTc5ODk1LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9._deFuXYQdzXwzy8T_9kzzA_CxIX_pPnaJKcgwaetKHg";
    const locationId = "YgQJt8zipheASmMz6HJf";
    let activeCategory = 'clients';
    let activeSubcategory = 'leads';
    let selectedContactId = null;
    let customFieldsMap = {};
    let customerCustomFields = [];

    // Define all 88 custom fields from Client Intake & Acquisition Form
    const customFieldLabels = [
      'Full Name', 'Address', 'Alternate Number', 'Citizenship Status', 'REIQ Checklist', 'Notes',
      'Upload DL/Passport', 'Alternate Email', 'Preferred Method of Communication', 'Type of Service',
      'Form 6 Sent?', 'Form 6 Executed', 'Form 6 Sent to All Parties', 'Client Agreement Sent?',
      'Client Agreement Executed', 'Client Agreement Sent to All Parties', 'Service Fee', 'Fee to be Paid',
      'Retainer Including GST', 'Retainer Invoice Paid', 'Referral Name', 'Referral Company',
      'Referral Phone', 'Referral Email', 'Referral Fee Paid?', 'Mortgage Company', 'Name of the Broker',
      'Address (Mortgage Broker)', 'Phone (Mortgage Broker)', 'Email (Mortgage Broker)', 'Finance Approval',
      'Date of Expiry', 'Name of the Conveyancer', 'Company (Conveyancer)', 'Address (Conveyancer)',
      'Phone (Conveyancer)', 'Email (Conveyancer)', 'Name of the Accountant', 'Company (Accountant)',
      'Address (Accountant)', 'Phone (Accountant)', 'Email (Accountant)', 'Name of the Financial Adviser',
      'Company (Financial Adviser)', 'Address (Financial Adviser)', 'Phone (Financial Adviser)',
      'Email (Financial Adviser)', 'Reason for Purchase', 'Strategy Outcomes', 'Tenant', 'Areas/Locations',
      'Building Type', 'Land Size', 'Budget', 'Time Frame', 'Must Haves', 'Second Choice Must Haves',
      'Previously Viewed Properties', 'Potential Properties', 'Property Identified', 'CMA Sent?', 'Flood',
      'Bushfire', 'Heritage', 'Title Search', 'Mortgage Broker Check Complete', 'Contract Sent to Solicitor',
      'Offer Received by Real Estate Agent', 'Full Name (Client 2)', 'Address (Client 2)',
      'Full Name (Client 3)', 'Phone (Client 2)', 'Phone (Client 3)', 'Alternate Number (Client 2)',
      'Alternate Number (Client 3)', 'Email (Client 2)', 'Alternate Email (Client 2)',
      'Alternate Email (Client 3)', 'Notes (Client 2)', 'Notes (Client 3)', 'Upload DL/Passport (Client 2)',
      'Upload DL/Passport (Client 3)', 'Citizenship Status (Client 2)', 'Citizenship Status (Client 3)',
      'REIQ Checklist (Client 2)', 'REIQ Checklist (Client 3)', 'Address (Client 3)', 'Email (Client 3)'
    ];

    // Fetch custom fields dynamically and map them
    async function fetchCustomFields() {
      const url = `https://rest.gohighlevel.com/v1/custom-fields?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('Custom Fields Response:', JSON.stringify(data, null, 2));

        customFieldsMap = data.customFields.reduce((map, field) => {
          map[field.label] = field.id;
          return map;
        }, {});

        customerCustomFields = customFieldLabels.map(label => {
          const id = customFieldsMap[label];
          if (!id) {
            console.warn(`Custom field "${label}" not found in GHL`);
            return null;
          }
          return {
            label,
            id,
            type: label.includes('Upload') || label.includes('REIQ Checklist') ? 'file' : label.includes('Notes') ? 'textarea' : 'text'
          };
        }).filter(field => field !== null);
      } catch (error) {
        console.error('Error fetching custom fields:', error);
      }
    }

    // Initial fetch of custom fields
    fetchCustomFields();

    function openModal() {
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal').classList.add('modal-open');
      setCategory('clients');
      setSubcategory('leads');
      loadContacts();
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
      closeForm();
    }

    function closeForm() { 
      document.getElementById('contact-form').style.display = 'none'; 
    }

    function setCategory(category) {
      closeForm();
      activeCategory = category;
      document.getElementById('subcategory-buttons').style.display = category === 'clients' ? 'flex' : 'none';
      setSubcategory(category === 'clients' ? 'leads' : '');
      document.querySelectorAll('#category-buttons .button').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'active:bg-blue-700');
        btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
      });
      document.querySelector(`#category-buttons .button[onclick="setCategory('${category}')"]`).classList.add('bg-blue-500', 'text-white', 'active:bg-blue-700');
    }

    function setSubcategory(subcategory) {
      closeForm();
      if (activeCategory !== 'clients') return;
      activeSubcategory = subcategory;
      loadContacts();
      document.getElementById('new-contact-btn').style.display = subcategory === 'leads' ? 'block' : 'none';
      document.querySelectorAll('#subcategory-buttons .button').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'active:bg-blue-700');
        btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
      });
      if (subcategory) {
        document.querySelector(`#subcategory-buttons .button[onclick="setSubcategory('${subcategory}')"]`).classList.add('bg-blue-500', 'text-white', 'active:bg-blue-700');
      }
    }

    async function loadContacts() {
      if (activeCategory !== 'clients' || !activeSubcategory) return;
      const tag = activeSubcategory === 'leads' ? 'new lead' : 'customer';
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(tag)}`;
      try {
        document.getElementById('contact-list').innerHTML = '<p class="text-gray-600 text-center py-4">Loading contacts...</p>';
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('API Response:', JSON.stringify(data, null, 2));

        const contacts = data.contacts || (data.contact ? [data.contact] : []);
        const filteredContacts = contacts.filter(contact => (contact.tags || []).includes(tag));

        const list = document.getElementById('contact-list');
        list.innerHTML = filteredContacts.length === 0 ? '<p class="text-gray-600 text-center py-4">No contacts found.</p>' : '';
        filteredContacts.forEach(contact => {
          const firstName = contact.firstName || 'Unknown';
          const lastName = contact.lastName || '';
          const contactId = contact.id;
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100';
          li.innerHTML = `
            <span class="text-gray-800">${firstName} ${lastName}</span>
            <div class="space-x-2">
              <button class="button bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600" onclick="loadContact('${contactId}')">View</button>
              ${activeSubcategory === 'leads' ? `<button class="button bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600" onclick="changeToCustomer('${contactId}')">Change to Customer</button>` : ''}
            </div>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contact-list').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contacts.</p>';
      }
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}&include=customFields`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        const contact = data.contact || data;
        console.log('Single Contact Response:', JSON.stringify(contact, null, 2));

        // Standard fields
        const standardFields = [
          { label: 'First Name', key: 'firstName', id: 'firstName', value: contact.firstName || '', required: true },
          { label: 'Last Name', key: 'lastName', id: 'lastName', value: contact.lastName || '', required: true },
          { label: 'Email', key: 'email', id: 'email', value: contact.email || '', type: 'email' },
          { label: 'Phone', key: 'phone', id: 'phone', value: contact.phone || '', type: 'tel' },
        ];

        document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
            <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
          </div>
        `).join('');

        // Custom fields for Customers
        const customFieldsDiv = document.getElementById('custom-fields');
        if (activeSubcategory === 'customers') {
          const customFieldValues = contact.customField || [];
          const fieldMap = customFieldValues.reduce((map, cf) => {
            const value = cf.value && typeof cf.value === 'object' ? cf.value[Object.keys(cf.value)[0]]?.url || cf.value : cf.value;
            map[cf.id] = value;
            return map;
          }, {});

          // Handle Full Name and Address as computed fields
          const fullNameValue = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
          const addressComponents = [
            fieldMap[customFieldsMap['Street Address']] || contact.address1 || '',
            fieldMap[customFieldsMap['City']] || contact.city || '',
            fieldMap[customFieldsMap['Country']] || contact.country || '',
            fieldMap[customFieldsMap['State']] || contact.state || '',
            fieldMap[customFieldsMap['Postal Code']] || contact.postalCode || ''
          ].filter(v => v);
          const addressValue = addressComponents.join(', ');

          document.getElementById('custom-fields').innerHTML = customerCustomFields.map(field => {
            let fieldValue = fieldMap[field.id] || '';
            if (field.label === 'Full Name') fieldValue = fullNameValue;
            if (field.label === 'Address') fieldValue = addressValue;
            if (field.type === 'file') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <p class="file-preview mb-2">${fieldValue ? `<a href="${fieldValue}" target="_blank" class="text-blue-500 hover:underline">${fieldValue.split('/').pop()}</a>` : 'No file uploaded'}</p>
                  <input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
              `;
            }
            return `
              <div class="form-group">
                <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                ${field.type === 'textarea' ? 
                  `<textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">${fieldValue}</textarea>` : 
                  `<input type="text" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">`}
              </div>
            `;
          }).join('');
        } else {
          customFieldsDiv.innerHTML = '';
        }

        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('contact-form').style.display = 'block';
      } catch (error) {
        console.error('Error loading contact:', error);
        document.getElementById('contact-form').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contact.</p>';
      }
    }

    async function showNewContactForm() {
      selectedContactId = null;
      const standardFields = [
        { label: 'First Name', key: 'firstName', id: 'firstName', value: '', required: true },
        { label: 'Last Name', key: 'lastName', id: 'lastName', value: '', required: true },
        { label: 'Email', key: 'email', id: 'email', value: '', type: 'email' },
        { label: 'Phone', key: 'phone', id: 'phone', value: '', type: 'tel' },
      ];

      document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
        <div class="form-group">
          <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
          <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
        </div>
      `).join('');

      document.getElementById('custom-fields').innerHTML = activeSubcategory === 'customers' ? 
        customerCustomFields.map(field => `
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
            ${field.type === 'file' ? 
              `<input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">` :
              field.type === 'textarea' ? 
              `<textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500"></textarea>` : 
              `<input type="text" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">`}
          </div>
        `).join('') : '';
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (e.target.id !== 'contact-form-element') return;

      const data = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [activeSubcategory === 'leads' ? 'new lead' : 'customer'],
      };

      // Construct address from component fields if needed
      const addressFields = ['Street Address', 'City', 'Country', 'State', 'Postal Code'].map(label => customFieldsMap[label]);
      if (activeSubcategory === 'customers' && addressFields.some(id => document.getElementById(`custom_${id}`))) {
        const address = addressFields.map(id => document.getElementById(`custom_${id}`)?.value || '').filter(v => v).join(', ');
        data.customField = data.customField || [];
        data.customField.push({ id: customFieldsMap['Address'], value: address || '' });
      }

      if (activeSubcategory === 'customers') {
        data.customField = await Promise.all(customerCustomFields.map(async field => {
          if (field.type === 'file') {
            const fileInput = document.getElementById(`custom_${field.id}_new`);
            if (fileInput && fileInput.files.length > 0) {
              const formData = new FormData();
              formData.append('file', fileInput.files[0]);
              formData.append('contactId', selectedContactId || '');
              formData.append('fieldId', field.id);

              try {
                const response = await fetch('https://custom-menu-backend-661398661b06.herokuapp.com/upload', { // Replace with your Heroku app URL
                  method: 'POST',
                  body: formData,
                });
                const result = await response.json();
                if (result.url) {
                  // Update the file preview in the UI
                  const preview = fileInput.parentElement.querySelector('.file-preview');
                  if (preview) {
                    preview.innerHTML = `<a href="${result.url}" target="_blank" class="text-blue-500 hover:underline">${result.url.split('/').pop()}</a>`;
                  }
                  return { id: field.id, value: result.url };
                }
                throw new Error('Upload failed');
              } catch (error) {
                console.error('File upload error:', error);
                return { id: field.id, value: '' };
              }
            }
            return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
          }
          return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
        }));
        data.customField = data.customField.filter(cf => cf.value !== '');
      }

      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        console.log('Save Contact Response:', await response.json());
        alert(selectedContactId ? 'Contact updated successfully!' : 'Contact created successfully!');
        closeForm();
        loadContacts();
      } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact. Please try again.');
      }
    });

    async function changeToCustomer(contactId) {
      selectedContactId = contactId;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');

        const updateResponse = await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        if (!updateResponse.ok) throw new Error(`HTTP error! Status: ${updateResponse.status}`);
        console.log('Tag Update Response:', await updateResponse.json());
        setSubcategory('customers');
        loadContact(contactId);
        alert('Contact changed to Customer successfully!');
      } catch (error) {
        console.error('Error changing to customer:', error);
        alert('Error changing contact to Customer.');
      }
    }
  </script>
</body>
</html>