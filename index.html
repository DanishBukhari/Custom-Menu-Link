<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-height: 70vh; overflow-y: auto; }
    .button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .active { background-color: #007bff; color: white; }
    .contact-list { list-style: none; padding: 0; }
    .contact-list li { padding: 10px; border-bottom: 1px solid #ddd; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; }
    .form-group input { width: 100%; padding: 5px; }
  </style>
</head>
<body>
  <div id="network-app">
    <div class="modal" id="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="category-buttons">
          <button class="button active" onclick="setCategory('clients')">Clients</button>
          <button class="button" onclick="setCategory('real estate')">Real Estate</button>
          <button class="button" onclick="setCategory('tradies')">Tradies</button>
        </div>
        <div id="subcategory-buttons" style="display: none;">
          <button class="button" onclick="setSubcategory('leads')">Leads</button>
          <button class="button" onclick="setSubcategory('customers')">Customers</button>
        </div>
        <div id="contact-list"></div>
        <div id="contact-form" style="display: none;">
          <h3 id="form-title"></h3>
          <form id="contact-form-element">
            <div class="form-group">
              <label>First Name:</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label>Last Name:</label>
              <input type="text" id="lastName" required>
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" id="email">
            </div>
            <div class="form-group">
              <label>Phone:</label>
              <input type="tel" id="phone">
            </div>
            <button type="submit" class="button">Save</button>
            <button type="button" class="button" onclick="closeForm()">Cancel</button>
          </form>
          <button id="new-contact-btn" class="button" style="display: none;" onclick="showNewContactForm()">New Contact</button>
        </div>
      </div>
    </div>
    <button class="button" onclick="openModal()">Network</button>
  </div>

  <script>
    // const apiKey = new URLSearchParams(window.location.search).get('apiKey');
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6Imp5YmQ1NUI2S0ozRktVRVQzYlIyIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4NzgyODcwMzU2LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9.wHqPiYxx1K_SNul1Lg40yK8IWS9qh0jQek32qajjf_s"
    // const locationId = new URLSearchParams(window.location.search).get('locationId');
    const locationId = "jybd55B6KJ3FKUET3bR2"
    let activeCategory = 'clients';
    let activeSubcategory = 'leads';
    let selectedContactId = null;

    function openModal() { document.getElementById('modal').style.display = 'block'; loadContacts(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function closeForm() { document.getElementById('contact-form').style.display = 'none'; }

    function setCategory(category) {
      activeCategory = category;
      document.getElementById('subcategory-buttons').style.display = category === 'clients' ? 'block' : 'none';
      setSubcategory(category === 'clients' ? 'leads' : '');
      document.querySelectorAll('#category-buttons .button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`#category-buttons .button[onclick="setCategory('${category}')"]`).classList.add('active');
    }

    function setSubcategory(subcategory) {
      if (activeCategory !== 'clients') return;
      activeSubcategory = subcategory;
      loadContacts();
      document.querySelectorAll('#subcategory-buttons .button').forEach(btn => btn.classList.remove('active'));
      if (subcategory) {
        document.querySelector(`#subcategory-buttons .button[onclick="setSubcategory('${subcategory}')"]`).classList.add('active');
      }
    }

    async function loadContacts() {
      if (activeCategory !== 'clients' || !activeSubcategory) return;
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(activeSubcategory === 'leads' ? 'new lead' : 'customer')}`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        const data = await response.json();
        const contacts = data.contacts || data.contact || [];
        const list = document.getElementById('contact-list');
        list.innerHTML = '';
        contacts.forEach(contact => {
          const li = document.createElement('li');
          li.innerHTML = `${contact.first_name} ${contact.last_name} <button class="button" onclick="loadContact('${contact.id}')">View</button>`;
          if (activeSubcategory === 'leads') {
            li.innerHTML += ` <button class="button" onclick="changeToCustomer('${contact.id}')">Change to Customer</button>`;
          }
          list.appendChild(li);
        });
        document.getElementById('new-contact-btn').style.display = 'block';
      } catch (error) {
        console.error('Error loading contacts:', error);
      }
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        const contact = await response.json();
        document.getElementById('firstName').value = contact.first_name || '';
        document.getElementById('lastName').value = contact.last_name || '';
        document.getElementById('email').value = contact.email || '';
        document.getElementById('phone').value = contact.phone || '';
        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('contact-form').style.display = 'block';
      } catch (error) {
        console.error('Error loading contact:', error);
      }
    }

    async function showNewContactForm() {
      selectedContactId = null;
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('email').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.getElementById('contact-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [activeSubcategory === 'leads' ? 'new lead' : 'customer'],
      };
      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;
      try {
        await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        closeForm();
        loadContacts();
      } catch (error) {
        console.error('Error saving contact:', error);
      }
    });

    async function changeToCustomer(contactId) {
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');
        await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        loadContacts();
      } catch (error) {
        console.error('Error changing to customer:', error);
      }
    }
  </script>
</body>
</html>