<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Interface</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for additional polish */
    .modal {
      transition: opacity 0.3s ease-in-out;
    }
    .modal-content {
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
    }
    .modal-open .modal-content {
      transform: translateY(0);
    }
    .button {
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .form-group input, .form-group textarea, .form-group select {
      transition: border-color 0.3s ease;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: #3b82f6;
      outline: none;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="network-app" class="w-full max-w-7xl p-4">
    <button class="button bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700" onclick="openModal()">Network</button>

    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" id="modal" style="display: none;">
      <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl p-6 max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-800">Network Contacts</h2>
          <span class="close text-3xl text-gray-500 cursor-pointer hover:text-gray-700" onclick="closeModal()">Ã—</span>
        </div>
        <div id="category-buttons" class="flex space-x-2 mb-4">
          <button class="button bg-blue-500 text-white px-4 py-2 rounded-lg active:bg-blue-700" onclick="setCategory('clients')">Clients</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setCategory('real estate')">Real Estate</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setCategory('tradies')">Tradies</button>
        </div>
        <div id="subcategory-buttons" class="flex space-x-2 mb-4" style="display: none;">
          <button class="button bg-blue-500 text-white px-4 py-2 rounded-lg active:bg-blue-700" onclick="setSubcategory('leads')">Leads</button>
          <button class="button bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400" onclick="setSubcategory('customers')">Customers</button>
        </div>
        <div id="contact-list" class="bg-gray-50 p-4 rounded-lg"></div>
        <button id="new-contact-btn" class="button bg-green-500 text-white px-4 py-2 rounded-lg mt-2 hover:bg-green-600" style="display: none;" onclick="showNewContactForm()">New Contact</button>
        <div id="contact-form" class="mt-4" style="display: none;">
          <h3 id="form-title" class="text-xl font-semibold text-gray-800 mb-4"></h3>
          <form id="contact-form-element">
            <div id="standard-fields" class="space-y-4"></div>
            <div id="custom-fields" class="space-y-4 mt-4"></div>
            <div class="flex space-x-2 mt-4">
              <button type="submit" class="button bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Save</button>
              <button type="button" class="button bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400" onclick="closeForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IllnUUp0OHppcGhlQVNtTXo2SEpmIiwidmVyc2lvbiI6MSwiaWF0IjoxNzQ4ODA3OTc5ODk1LCJzdWIiOiJ6OVNaSGxKT29KVHI4MjA5OGNLOCJ9._deFuXYQdzXwzy8T_9kzzA_CxIX_pPnaJKcgwaetKHg";
    const locationId = "YgQJt8zipheASmMz6HJf";
    let activeCategory = 'clients';
    let activeSubcategory = 'leads';
    let selectedContactId = null;

    // Define all 88 custom fields with their IDs and types
    const customerCustomFields = [
      { label: 'Full Name', id: 'EXjXnQEL140VE4XYhaSX', type: 'TEXT' },
      { label: 'Address', id: 'xiMyfob6XvYdCJ2mUFvs', type: 'LARGE_TEXT' },
      { label: 'Alternate Number', id: 'jvAsiZOUQaCGJIovm6ow', type: 'PHONE' },
      { label: 'Citizenship Status', id: 'KZXiIduGXfQa4gcpSAHv', type: 'TEXT' },
      { label: 'REIQ Checklist', id: 'rxOfHP9T8qdurVaokT2s', type: 'FILE_UPLOAD' },
      { label: 'Notes', id: 'NvQGPZLuWhQ9yYXKp9ld', type: 'LARGE_TEXT' },
      { label: 'Upload DL/Passport', id: 'HOhKJUkCUTScTWamVlZf', type: 'FILE_UPLOAD' },
      { label: 'Alternate email', id: 'PEVvVcPisnmdY3qoYwyR', type: 'TEXT' },
      { label: 'Preferred Method of Communication', id: 'grhYMh52GpDD8QuNuo0J', type: 'MULTIPLE_OPTIONS', options: ['Email', 'Phone', 'Text', 'In-Person'] },
      { label: 'Type of Service', id: 'sHX29V5gxwBYO4WMTQHp', type: 'SINGLE_OPTIONS', options: ['Full Service Buyers Advocacy', 'Auction Bidding', 'Negotiation Only'] },
      { label: 'Form 6 Sent?', id: 'PR7PRh4wuvF9yrMLhaZF', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Form 6 Executed', id: 'KQz5NQgoGq1l6sI8YPk6', type: 'CHECKBOX', options: ['Yes, Signed by all parties'] },
      { label: 'Form 6 Sent to all parties', id: 'APFoTEdW0JHfH5uJIqUL', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Client Agreement Sent?', id: 'iPFysM90lheoQzV0FOBM', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Client Agreement Executed', id: '4sFw9DsvvygEWyyl2wOx', type: 'CHECKBOX', options: ['Yes, Agreement Signed'] },
      { label: 'Client Agreement sent to all Parties', id: 'CL0w2AcSvCkjyo4L15ip', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Service Fee', id: 'FLP394K9sPjDT21C0Yda', type: 'TEXT' },
      { label: 'Fee to be Paid', id: 'E6fHsabXPU5QkUd3f6wI', type: 'SINGLE_OPTIONS', options: ['Unconditional', 'Conditional', 'Not Applicable'] },
      { label: 'Retainer including GST', id: 'qcWKnqkUOgM3X9bVCrbO', type: 'TEXT' },
      { label: 'Retainer Invoice Paid', id: 'yGmz10g9dX8itDkh5Emo', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Referral Name', id: '6uIIMjIfV0XQ4jwn1ZXv', type: 'TEXT' },
      { label: 'Referral Company', id: 'yb56Vm4w6pioj7Ry8xOi', type: 'TEXT' },
      { label: 'Referral Phone', id: 'mhRM0JSI71O4bE6D9HnA', type: 'PHONE' },
      { label: 'Referral Email', id: '7Yfw3ndm4LlMZWRt08l1', type: 'TEXT' },
      { label: 'Referral Fee Paid?', id: '6AlnT4R8lKsHz12XIuht', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Mortgage Company', id: 'lOWvhGItK1DfcYdmEmr5', type: 'TEXT' },
      { label: 'Name of the Broker', id: 'zF8zaixssgBPmrmaKFv7', type: 'TEXT' },
      { label: 'Address (Mortgage Broker)', id: 'v6YC1hH9al2CAH2O1YQZ', type: 'LARGE_TEXT' },
      { label: 'Phone (Mortgage Broker)', id: '4nfCxk7ACGXPJYOhZ98q', type: 'PHONE' },
      { label: 'Email (Mortgage Broker)', id: 'S2AKVZq7g9sXm7Qnf4ad', type: 'TEXT' },
      { label: 'Finance Approval', id: 'VDFuiC8FcBXn6A6g0eW9', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Date of Expiry', id: '2jj35L7SgYQVh22CjA4b', type: 'DATE' },
      { label: 'Name of the Conveyancer', id: '5MfJnwZsjSpGpJNGFqBj', type: 'TEXT' },
      { label: 'Company (Conveyancer)', id: '5JEWkh4EfSQ1wEc0pfEq', type: 'TEXT' },
      { label: 'Address (Conveyancer)', id: 'RbnDMwGZxcCw2TAhtXdf', type: 'LARGE_TEXT' },
      { label: 'Phone (Conveyancer)', id: 'zLWuKlNFCy77I9Rh2JUg', type: 'PHONE' },
      { label: 'Email (Conveyancer)', id: 'sc3jlus2FEvrZo6bkGGs', type: 'TEXT' },
      { label: 'Name of the Accountant', id: '4O8RZbvD8yAt9jxsaL8f', type: 'TEXT' },
      { label: 'Company (Accountant)', id: 'uj1nEbRZRfU61BEAXItg', type: 'TEXT' },
      { label: 'Address (Accountant)', id: 'yJZJ5PlmZDaHKkz2hy3M', type: 'LARGE_TEXT' },
      { label: 'Phone (Accountant)', id: 'iE8WWJ9Ye7Z32To1KGoy', type: 'PHONE' },
      { label: 'Email (Accountant)', id: 'LRS2RQjK5qYL8fWyfxzs', type: 'TEXT' },
      { label: 'Name of the Financial Adviser', id: 'YInzODdGmRDeWGvtA6kv', type: 'TEXT' },
      { label: 'Company (Financial Adviser)', id: 'nnxNZEZSg6Nw1sysMzhh', type: 'TEXT' },
      { label: 'Address (Financial Adviser)', id: 'p61NEhKJLIOyIz7qeqpb', type: 'LARGE_TEXT' },
      { label: 'Phone (Financial Adviser)', id: 'P1y8L9Xk1N9eRdQ2rKVr', type: 'PHONE' },
      { label: 'Email (Financial Adviser)', id: 'gINIpN4sR404ahNgyPkX', type: 'TEXT' },
      { label: 'Reason for Purchase', id: 'ti1qc7zG8ZVBfnkqm7Zd', type: 'MULTIPLE_OPTIONS', options: ['Owner Occupier', 'Investment', 'Holiday Home'] },
      { label: 'Strategy Outcomes', id: 'uAq6W9XWSaqTU9P5mSxr', type: 'MULTIPLE_OPTIONS', options: ['Renovation Potential', 'Subdivision Potential', 'Development Potential'] },
      { label: 'Tenant', id: 'jUJ7iCewuxlFttWfPLLu', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Areas/Locations', id: 'fqANWu9PRJHBs0A0PVOe', type: 'LARGE_TEXT' },
      { label: 'Building Type', id: 'nLNN1njsqcMmImQXDZdU', type: 'LARGE_TEXT' },
      { label: 'Land Size', id: 'jkLvLtBIenZ66IHg0u8G', type: 'LARGE_TEXT' },
      { label: 'Budget', id: 'AysRDNDmW7NEmgkxG0Pc', type: 'LARGE_TEXT' },
      { label: 'Time Frame', id: 'MHQP9pQgsvadprNyXCIy', type: 'LARGE_TEXT' },
      { label: 'Must Haves', id: 'XITF19lX0YYapZCBT23E', type: 'LARGE_TEXT' },
      { label: 'Second Choice Must Haves', id: '2GkoU8Lh72AC5BwPSFzf', type: 'LARGE_TEXT' },
      { label: 'Previously Viewed Properties', id: 'raEuLUqKopdXzxvIreDU', type: 'LARGE_TEXT' },
      { label: 'Potential Properties', id: 'daYmzLY5IFA9g8n09ONs', type: 'LARGE_TEXT' },
      { label: 'Property Identified', id: 'Lyv7eAn1tBgDzpToEgdf', type: 'LARGE_TEXT' },
      { label: 'CMA Sent?', id: 'ccHSnDHKJFi7PZOtn9zt', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Flood', id: 'JNxCzxrxifroeclObyRB', type: 'FILE_UPLOAD' },
      { label: 'Bushfire', id: 'wapXPv1hnCYDpDK1vfTa', type: 'FILE_UPLOAD' },
      { label: 'Heritage', id: 'm9i7HQXWY17PfBBFoOwc', type: 'FILE_UPLOAD' },
      { label: 'Title Search', id: 'txxrIggN291g9OISLz3y', type: 'LARGE_TEXT' },
      { label: 'Mortgage Broker Check Complete', id: 'zVVmbafhz3TZ1xfOK9yj', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Contract Sent to Solicitor', id: 'wHB4bJhT9kuFPNAHMygP', type: 'LARGE_TEXT' },
      { label: 'Offer received by real estate agent', id: '634PeulkBMxDwi5Mw9tf', type: 'RADIO', options: ['Yes', 'No'] },
      { label: 'Full Name (Client 2)', id: 'NcZ9Q0kt2Um0idKhmIhM', type: 'TEXT' },
      { label: 'Address (Client 2)', id: 'jEH869tIk7awVG3y7L62', type: 'LARGE_TEXT' },
      { label: 'Full Name (Client 3)', id: '7Jde9fNNqL8K9XHCy7u5', type: 'TEXT' },
      { label: 'Phone (Client 2)', id: 'OSkhPsIb5CaLsfHFVVVl', type: 'PHONE' },
      { label: 'Phone (Client 3)', id: 'IKAkpbKPUQfPDGqml4U9', type: 'PHONE' },
      { label: 'Alternate Number (Client 2)', id: 'rGl3o463R2k6pHA2sUTr', type: 'PHONE' },
      { label: 'Alternate Number (Client 3)', id: 'BrLRYmiETzuMOpZcJoAj', type: 'PHONE' },
      { label: 'Email (Client 2)', id: 'I0XR6vaXZl9bDrgbClFn', type: 'TEXT' },
      { label: 'Alternate email (Client 2)', id: '6G3biDu17n4DTjb3bT4Y', type: 'TEXT' },
      { label: 'Alternate email (Client 3)', id: 'hH7IcmQZgEwHzIjFJB6j', type: 'TEXT' },
      { label: 'Notes (Client 2)', id: 'MjyKkWTESS8hNXmjVGwo', type: 'LARGE_TEXT' },
      { label: 'Notes (Client 3)', id: '2gwL1Xt4gpLXPvIq8l0X', type: 'LARGE_TEXT' },
      { label: 'Upload DL/Passport (Client 2)', id: '6Kkzjrfw2H9PnKbrHfxZ', type: 'FILE_UPLOAD' },
      { label: 'Upload DL/Passport (Client 3)', id: 'sLy2EQaKQkHZvTvQc0OS', type: 'FILE_UPLOAD' },
      { label: 'Citizenship Status (Client 2)', id: 'OfCZ3qfSOkcjb8JXG7Nj', type: 'TEXT' },
      { label: 'Citizenship Status (Client 3)', id: '5QyH4ryvNdDopxkLa1pT', type: 'TEXT' },
      { label: 'REIQ Checklist (Client 2)', id: '0TR2XsNuizgdI43JuI9X', type: 'FILE_UPLOAD' },
      { label: 'REIQ Checklist (Client 3)', id: 'zBRgbclelurPoN84ZqRX', type: 'FILE_UPLOAD' },
      { label: 'Address (Client 3)', id: 'tVcyZhEtB0G3ydzQB2vi', type: 'LARGE_TEXT' },
      { label: 'Email (Client 3)', id: '0BgAiLdSVF9JxQ28qibZ', type: 'TEXT' }
    ];

    function openModal() {
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal').classList.add('modal-open');
      setCategory('clients');
      setSubcategory('leads');
      loadContacts();
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
      closeForm();
    }

    function closeForm() { 
      document.getElementById('contact-form').style.display = 'none'; 
    }

    function setCategory(category) {
      closeForm();
      activeCategory = category;
      document.getElementById('subcategory-buttons').style.display = category === 'clients' ? 'flex' : 'none';
      setSubcategory(category === 'clients' ? 'leads' : '');
      document.querySelectorAll('#category-buttons .button').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'active:bg-blue-700');
        btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
      });
      document.querySelector(`#category-buttons .button[onclick="setCategory('${category}')"]`).classList.add('bg-blue-500', 'text-white', 'active:bg-blue-700');
    }

    function setSubcategory(subcategory) {
      closeForm();
      if (activeCategory !== 'clients') return;
      activeSubcategory = subcategory;
      loadContacts();
      document.getElementById('new-contact-btn').style.display = subcategory === 'leads' ? 'block' : 'none';
      document.querySelectorAll('#subcategory-buttons .button').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'active:bg-blue-700');
        btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
      });
      if (subcategory) {
        document.querySelector(`#subcategory-buttons .button[onclick="setSubcategory('${subcategory}')"]`).classList.add('bg-blue-500', 'text-white', 'active:bg-blue-700');
      }
    }

    async function loadContacts() {
      if (activeCategory !== 'clients' || !activeSubcategory) return;
      const tag = activeSubcategory === 'leads' ? 'new lead' : 'customer';
      const url = `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}&tags=${encodeURIComponent(tag)}`;
      try {
        document.getElementById('contact-list').innerHTML = '<p class="text-gray-600 text-center py-4">Loading contacts...</p>';
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        console.log('API Response:', JSON.stringify(data, null, 2));

        const contacts = data.contacts || (data.contact ? [data.contact] : []);
        const filteredContacts = contacts.filter(contact => (contact.tags || []).includes(tag));

        const list = document.getElementById('contact-list');
        list.innerHTML = filteredContacts.length === 0 ? '<p class="text-gray-600 text-center py-4">No contacts found.</p>' : '';
        filteredContacts.forEach(contact => {
          const firstName = contact.firstName || 'Unknown';
          const lastName = contact.lastName || '';
          const contactId = contact.id;
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100';
          li.innerHTML = `
            <span class="text-gray-800">${firstName} ${lastName}</span>
            <div class="space-x-2">
              <button class="button bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600" onclick="loadContact('${contactId}')">View</button>
              ${activeSubcategory === 'leads' ? `<button class="button bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600" onclick="changeToCustomer('${contactId}')">Change to Customer</button>` : ''}
            </div>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contact-list').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contacts.</p>';
      }
    }

    async function loadContact(contactId) {
      selectedContactId = contactId;
      const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}&include=customFields`;
      try {
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        const contact = data.contact || data;
        console.log('Single Contact Response:', JSON.stringify(contact, null, 2));

        // Standard fields
        const standardFields = [
          { label: 'First Name', key: 'firstName', id: 'firstName', value: contact.firstName || '', required: true },
          { label: 'Last Name', key: 'lastName', id: 'lastName', value: contact.lastName || '', required: true },
          { label: 'Email', key: 'email', id: 'email', value: contact.email || '', type: 'email' },
          { label: 'Phone', key: 'phone', id: 'phone', value: contact.phone || '', type: 'tel' },
        ];

        document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
            <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
          </div>
        `).join('');

        // Custom fields for Customers
        const customFieldsDiv = document.getElementById('custom-fields');
        if (activeSubcategory === 'customers') {
          const customFieldValues = contact.customField || [];
          const fieldMap = customFieldValues.reduce((map, cf) => {
            const value = cf.value && typeof cf.value === 'object' ? cf.value[Object.keys(cf.value)[0]]?.url || cf.value : cf.value;
            map[cf.id] = value || '';
            return map;
          }, {});

          // Handle Full Name and Address as computed fields
          const fullNameValue = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
          const addressComponents = [
            fieldMap['xiMyfob6XvYdCJ2mUFvs'] || contact.address1 || '',
            fieldMap['city'] || contact.city || '',
            fieldMap['country'] || contact.country || '',
            fieldMap['state'] || contact.state || '',
            fieldMap['postalCode'] || contact.postalCode || ''
          ].filter(v => v);
          const addressValue = addressComponents.join(', ');

          document.getElementById('custom-fields').innerHTML = customerCustomFields.map(field => {
            let fieldValue = fieldMap[field.id] || '';
            if (field.label === 'Full Name') fieldValue = fullNameValue;
            if (field.label === 'Address') fieldValue = addressValue;

            if (field.type === 'FILE_UPLOAD') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <p class="file-preview mb-2">${fieldValue ? `<a href="${fieldValue}" target="_blank" class="text-blue-500 hover:underline">${fieldValue.split('/').pop()}</a>` : 'No file uploaded'}</p>
                  <input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
              `;
            } else if (field.type === 'LARGE_TEXT') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">${fieldValue}</textarea>
                </div>
              `;
            } else if (field.type === 'RADIO' || field.type === 'SINGLE_OPTIONS') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <option value="">Select an option</option>
                    ${field.options.map(option => `
                      <option value="${option}" ${fieldValue === option ? 'selected' : ''}>${option}</option>
                    `).join('')}
                  </select>
                </div>
              `;
            } else if (field.type === 'MULTIPLE_OPTIONS') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <select id="custom_${field.id}" multiple class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    ${field.options.map(option => `
                      <option value="${option}" ${Array.isArray(fieldValue) && fieldValue.includes(option) ? 'selected' : ''}>${option}</option>
                    `).join('')}
                  </select>
                </div>
              `;
            } else if (field.type === 'CHECKBOX') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  ${field.options.map(option => `
                    <label class="inline-flex items-center mr-4">
                      <input type="checkbox" id="custom_${field.id}_${option}" value="${option}" ${Array.isArray(fieldValue) && fieldValue.includes(option) ? 'checked' : ''} class="mr-2">
                      <span>${option}</span>
                    </label>
                  `).join('')}
                </div>
              `;
            } else if (field.type === 'DATE') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <input type="date" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                </div>
              `;
            } else if (field.type === 'PHONE') {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <input type="tel" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                </div>
              `;
            } else {
              return `
                <div class="form-group">
                  <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
                  <input type="text" id="custom_${field.id}" value="${fieldValue}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                </div>
              `;
            }
          }).join('');
        } else {
          customFieldsDiv.innerHTML = '';
        }

        document.getElementById('form-title').textContent = 'Edit Contact';
        document.getElementById('contact-form').style.display = 'block';
      } catch (error) {
        console.error('Error loading contact:', error);
        document.getElementById('contact-form').innerHTML = '<p class="text-red-500 text-center py-4">Error loading contact.</p>';
      }
    }

    async function showNewContactForm() {
      selectedContactId = null;
      const standardFields = [
        { label: 'First Name', key: 'firstName', id: 'firstName', value: '', required: true },
        { label: 'Last Name', key: 'lastName', id: 'lastName', value: '', required: true },
        { label: 'Email', key: 'email', id: 'email', value: '', type: 'email' },
        { label: 'Phone', key: 'phone', id: 'phone', value: '', type: 'tel' },
      ];

      document.getElementById('standard-fields').innerHTML = standardFields.map(field => `
        <div class="form-group">
          <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
          <input type="${field.type || 'text'}" id="${field.id}" value="${field.value}" ${field.required ? 'required' : ''} class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
        </div>
      `).join('');

      document.getElementById('custom-fields').innerHTML = activeSubcategory === 'customers' ? 
        customerCustomFields.map(field => `
          <div class="form-group">
            <label class="block text-gray-700 font-medium mb-1">${field.label}:</label>
            ${field.type === 'FILE_UPLOAD' ? 
              `<input type="file" id="custom_${field.id}_new" accept="image/*,application/pdf" class="w-full p-2 border border-gray-300 rounded-lg">` :
              field.type === 'LARGE_TEXT' ? 
              `<textarea id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500"></textarea>` :
              field.type === 'RADIO' || field.type === 'SINGLE_OPTIONS' ? 
              `<select id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                <option value="">Select an option</option>
                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>` :
              field.type === 'MULTIPLE_OPTIONS' ? 
              `<select id="custom_${field.id}" multiple class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">
                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>` :
              field.type === 'CHECKBOX' ? 
              field.options.map(option => `
                <label class="inline-flex items-center mr-4">
                  <input type="checkbox" id="custom_${field.id}_${option}" value="${option}" class="mr-2">
                  <span>${option}</span>
                </label>
              `).join('') :
              field.type === 'DATE' ? 
              `<input type="date" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">` :
              field.type === 'PHONE' ? 
              `<input type="tel" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">` :
              `<input type="text" id="custom_${field.id}" class="w-full p-2 border border-gray-300 rounded-lg focus:border-blue-500">`}
          </div>
        `).join('') : '';
      document.getElementById('form-title').textContent = 'Create New Contact';
      document.getElementById('contact-form').style.display = 'block';
    }

    document.getElementById('contact-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        tags: [activeSubcategory === 'leads' ? 'new lead' : 'customer'],
      };

      // Construct address from component fields if needed
      const addressFields = ['xiMyfob6XvYdCJ2mUFvs', 'city', 'country', 'state', 'postalCode'];
      if (activeSubcategory === 'customers' && addressFields.some(id => document.getElementById(`custom_${id}`))) {
        const address = addressFields.map(id => document.getElementById(`custom_${id}`)?.value || '').filter(v => v).join(', ');
        data.customField = data.customField || [];
        data.customField.push({ id: 'xiMyfob6XvYdCJ2mUFvs', value: address || '' });
      }

      if (activeSubcategory === 'customers') {
        data.customField = await Promise.all(customerCustomFields.map(async field => {
          if (field.type === 'FILE_UPLOAD') {
            const fileInput = document.getElementById(`custom_${field.id}_new`);
            if (fileInput && fileInput.files.length > 0) {
              const formData = new FormData();
              formData.append('file', fileInput.files[0]);
              formData.append('contactId', selectedContactId || '');
              formData.append('fieldId', field.id);

              try {
                const response = await fetch('https://custom-menu-backend-661398661b06.herokuapp.com/upload', { // Replace with your Heroku app URL
                  method: 'POST',
                  body: formData,
                });
                const result = await response.json();
                if (result.url) {
                  // Update the file preview in the UI
                  const preview = fileInput.parentElement.querySelector('.file-preview');
                  if (preview) {
                    preview.innerHTML = `<a href="${result.url}" target="_blank" class="text-blue-500 hover:underline">${result.url.split('/').pop()}</a>`;
                  }
                  return { id: field.id, value: result.url };
                }
                throw new Error('Upload failed');
              } catch (error) {
                console.error('File upload error:', error);
                return { id: field.id, value: '' };
              }
            }
            return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
          } else if (field.type === 'CHECKBOX' || field.type === 'MULTIPLE_OPTIONS') {
            let selectedOptions = [];
            const selectElement = document.getElementById(`custom_${field.id}`);
            if (selectElement && selectElement.tagName === 'SELECT' && selectElement.multiple) {
              selectedOptions = Array.from(selectElement.selectedOptions || []).map(opt => opt.value);
            } else if (field.type === 'CHECKBOX') {
              field.options.forEach(option => {
                const checkbox = document.getElementById(`custom_${field.id}_${option}`);
                if (checkbox && checkbox.checked) selectedOptions.push(option);
              });
            }
            return { id: field.id, value: selectedOptions.length > 0 ? selectedOptions : '' };
          } else {
            return { id: field.id, value: document.getElementById(`custom_${field.id}`)?.value || '' };
          }
        }));
        data.customField = data.customField.filter(cf => cf.value !== '' && cf.value.length !== 0);
      }

      const url = selectedContactId
        ? `https://rest.gohighlevel.com/v1/contacts/${selectedContactId}?locationId=${locationId}`
        : `https://rest.gohighlevel.com/v1/contacts?locationId=${locationId}`;
      try {
        const response = await fetch(url, {
          method: selectedContactId ? 'PUT' : 'POST',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        console.log('Save Contact Response:', await response.json());
        alert(selectedContactId ? 'Contact updated successfully!' : 'Contact created successfully!');
        closeForm();
        loadContacts();
      } catch (error) {
        console.error('Error saving contact:', error);
        alert('Error saving contact. Please try again.');
      }
    });

    async function changeToCustomer(contactId) {
      selectedContactId = contactId;
      try {
        const url = `https://rest.gohighlevel.com/v1/contacts/${contactId}?locationId=${locationId}`;
        const response = await fetch(url, {
          headers: { Authorization: `Bearer ${apiKey}` },
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const contact = await response.json();
        let tags = contact.tags || [];
        tags = tags.filter(tag => tag !== 'new lead');
        if (!tags.includes('customer')) tags.push('customer');

        const updateResponse = await fetch(url, {
          method: 'PUT',
          headers: { Authorization: `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags }),
        });
        if (!updateResponse.ok) throw new Error(`HTTP error! Status: ${updateResponse.status}`);
        console.log('Tag Update Response:', await updateResponse.json());
        setSubcategory('customers');
        loadContact(contactId);
        alert('Contact changed to Customer successfully!');
      } catch (error) {
        console.error('Error changing to customer:', error);
        alert('Error changing contact to Customer.');
      }
    }
  </script>
</body>
</html>